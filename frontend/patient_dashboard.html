<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Patient Dashboard - Hospital Management</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f4f6fb; }
  header { background:#2f80ed;color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center }
  header h1 { margin:0; font-size:20px; }
  .container{ padding:20px; max-width:1000px; margin:auto }
  .card{ background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:16px;margin-bottom:18px }
  table{ width:100%; border-collapse:collapse; font-size:14px }
  th,td{ border:1px solid #e5e7eb; padding:10px; text-align:left }
  th{ background:#2f80ed; color:#fff }
  button.primary{ background:#2f80ed;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer }
  button.primary:hover { background:#1f5bb5; }
  input,select,textarea{ width:100%; padding:8px;border:1px solid #d1d5db;border-radius:6px;margin:6px 0; font-size:14px }
  /* Chatbot styles */
  #chatbotBtn{position:fixed;bottom:20px;right:20px;background:#2f80ed;color:#fff;border:none;border-radius:50%;width:60px;height:60px;font-size:24px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.3);z-index:9999}
  #chatWindow{position:fixed;bottom:90px;right:20px;width:320px;height:440px;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.3);display:none;flex-direction:column;overflow:hidden;z-index:9999}
  #chatMessages{flex:1;padding:12px;overflow-y:auto;font-size:14px;background:#fafbff}
  .msg-user{text-align:right;color:#2f80ed;margin:6px 0;white-space:pre-wrap}
  .msg-bot{text-align:left;color:#333;margin:6px 0;white-space:pre-wrap}
  #chatInput{display:flex;border-top:1px solid #e5e7eb}
  #chatInput input{flex:1;padding:10px;border:none;outline:none}
  #chatInput button{padding:10px 14px;background:#2f80ed;color:#fff;border:none;cursor:pointer}
</style>
</head>
<body>

<header>
  <h1>Patient Dashboard</h1>
  <button class="primary" onclick="logout()">Logout</button>
</header>

<div class="container">

  <div class="card">
    <h2>Upcoming Appointments</h2>
    <table id="upcomingTable">
      <thead><tr><th>Date</th><th>Time</th><th>Doctor</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Past Appointments & Prescriptions</h2>
    <table id="pastTable">
      <thead><tr><th>Date</th><th>Time</th><th>Doctor</th><th>Prescription</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Book Appointment</h2>
    <label>Select Doctor</label>
    <select id="doctorSelect"></select>

    <label>Select Date</label>
    <input type="date" id="apptDate">

    <label>Available Slots</label>
    <select id="slotSelect"></select>

    <button class="primary" onclick="bookAppointment()">Book</button>
  </div>

  <div class="card">
    <h2>Upload Medical Document</h2>
    <input type="file" id="docFile">
    <button class="primary" onclick="uploadDocument()">Upload</button>
    <ul id="docList"></ul>
  </div>

</div>

<!-- Chatbot UI -->
<button id="chatbotBtn" title="Chat">ðŸ’¬</button>
<div id="chatWindow">
  <div id="chatMessages"></div>
  <div id="chatInput">
    <input type="text" id="chatText" placeholder="Ask health-related questions...">
    <button id="chatSend">Send</button>
  </div>
</div>

<script>
const token = localStorage.getItem("authToken");
if (!token) {
  alert("Please login first.");
  window.location.href = "login.html";
}

async function loadPatientDashboard() {
  try {
    const res = await fetch("http://127.0.0.1:8000/api/patient/dashboard/", {
      headers: { "Authorization": `Token ${token}` }
    });
    const data = await res.json();

    const upT = document.querySelector("#upcomingTable tbody");
    const pastT = document.querySelector("#pastTable tbody");
    upT.innerHTML = "";
    pastT.innerHTML = "";

    (data.upcoming || []).forEach(a => {
      upT.innerHTML += `<tr>
        <td>${a.date}</td><td>${a.time}</td><td>${a.doctor_name}</td><td>${a.status}</td>
      </tr>`;
    });

    (data.past || []).forEach(a => {
      pastT.innerHTML += `<tr>
        <td>${a.date}</td><td>${a.time}</td><td>${a.doctor_name}</td><td>${a.prescription || "N/A"}</td>
      </tr>`;
    });

    loadDoctors();

  } catch {
    alert("Failed to load dashboard.");
  }
}

async function loadDoctors() {
  const res = await fetch("http://127.0.0.1:8000/api/doctors/", {
    headers: { "Authorization": `Token ${token}` }
  });
  const data = await res.json();
  const select = document.getElementById("doctorSelect");
  select.innerHTML = "";
  data.forEach(d => {
    select.innerHTML += `<option value="${d.id}">${d.name} (${d.specialization})</option>`;
  });
}

document.getElementById("apptDate").addEventListener("change", loadSlots);
document.getElementById("doctorSelect").addEventListener("change", loadSlots);

async function loadSlots() {
  const docId = document.getElementById("doctorSelect").value;
  const date = document.getElementById("apptDate").value;
  if (!docId || !date) return;
  const res = await fetch(`http://127.0.0.1:8000/api/slots/?doctor_id=${docId}&date=${date}`, {
    headers: { "Authorization": `Token ${token}` }
  });
  const data = await res.json();
  const select = document.getElementById("slotSelect");
  select.innerHTML = "";
  (data || []).forEach(s => {
    select.innerHTML += `<option value="${s}">${s}</option>`;
  });
}

async function bookAppointment() {
  const doctor_id = document.getElementById("doctorSelect").value;
  const date = document.getElementById("apptDate").value;
  const time = document.getElementById("slotSelect").value;
  if (!doctor_id || !date || !time) return alert("Select doctor, date, and slot.");
  const res = await fetch("http://127.0.0.1:8000/api/appointments/", {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": `Token ${token}` },
    body: JSON.stringify({ doctor_id, date, time })
  });
  const data = await res.json();
  if (res.ok) { alert("Appointment booked!"); loadPatientDashboard(); }
  else { alert(data.detail || "Booking failed."); }
}

async function uploadDocument() {
  const file = document.getElementById("docFile").files[0];
  if (!file) return alert("Please select a file.");
  const formData = new FormData();
  formData.append("file", file);
  const res = await fetch("http://127.0.0.1:8000/api/documents/", {
    method: "POST",
    headers: { "Authorization": `Token ${token}` },
    body: formData
  });
  const data = await res.json();
  if (res.ok) { alert("Uploaded!"); loadDocuments(); }
  else { alert(data.detail || "Upload failed."); }
}

async function loadDocuments() {
  const res = await fetch("http://127.0.0.1:8000/api/documents/", {
    headers: { "Authorization": `Token ${token}` }
  });
  const data = await res.json();
  const list = document.getElementById("docList");
  list.innerHTML = "";
  data.forEach(doc => {
    list.innerHTML += `<li><a href="${doc.file}" target="_blank">${doc.filename}</a></li>`;
  });
}

function logout() {
  localStorage.removeItem("authToken");
  window.location.href = "login.html";
}

// Chatbot
const chatBtn = document.getElementById("chatbotBtn");
const chatWin = document.getElementById("chatWindow");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatText");
const chatSend = document.getElementById("chatSend");
let history = [];

chatBtn.addEventListener("click", () => {
  chatWin.style.display = chatWin.style.display === "none" ? "flex" : "none";
});

function addMsg(text, sender) {
  const div = document.createElement("div");
  div.className = sender === "user" ? "msg-user" : "msg-bot";
  div.textContent = text;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendChat() {
  const text = chatInput.value.trim();
  if (!text) return;
  addMsg(text, "user");
  history.push({ role: "user", content: text });
  chatInput.value = "";
  try {
    const res = await fetch("http://127.0.0.1:8000/api/chat/", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Token ${token}` },
      body: JSON.stringify({ messages: history })
    });
    const data = await res.json();
    if (res.ok && data.reply) {
      addMsg(data.reply, "bot");
      history.push({ role: "assistant", content: data.reply });
    } else {
      addMsg(data.detail || "Error: Unable to get response.", "bot");
    }
  } catch {
    addMsg("Error: Could not connect to chatbot.", "bot");
  }
}

chatSend.addEventListener("click", sendChat);
chatInput.addEventListener("keydown", e => { if (e.key === "Enter") sendChat(); });

loadPatientDashboard();
loadDocuments();
</script>
</body>
</html>
