<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Dashboard - Hospital Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 15px;
        overflow-x: hidden;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 25px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      .header h1 {
        font-size: 2.3rem;
        margin-bottom: 15px;
        text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        font-weight: 700;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.95;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .nav-bar {
        background: rgba(52, 73, 94, 0.95);
        backdrop-filter: blur(10px);
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .nav-links {
        display: flex;
        gap: 20px;
      }

      .nav-links a {
        color: white;
        text-decoration: none;
        padding: 10px 18px;
        border-radius: 25px;
        transition: all 0.3s ease;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
      }

      .nav-links a:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      .logout-btn {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
      }

      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(231, 76, 60, 0.6);
      }

      .main-content {
        padding: 30px;
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 22px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #667eea);
        background-size: 300% 100%;
        animation: gradientShift 4s ease infinite;
      }

      @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }

      .section:hover {
        transform: translateY(-5px);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      }

      .section h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.3rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section h3::after {
        content: '';
        flex: 1;
        height: 2px;
        background: linear-gradient(90deg, #3498db, transparent);
        margin-left: 15px;
      }

      .appointment-card {
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 18px;
        margin-bottom: 16px;
        border-left: 4px solid #3498db;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .appointment-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
        transition: left 0.5s ease;
      }

      .appointment-card:hover::before {
        left: 100%;
      }

      .appointment-card:hover {
        transform: translateX(8px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
      }

      .appointment-card.today {
        border-left-color: #e74c3c;
        background: linear-gradient(145deg, #fff5f5, #ffe8e6);
        box-shadow: 0 8px 25px rgba(231, 76, 60, 0.15);
      }

      .appointment-card.completed {
        border-left-color: #27ae60;
        background: linear-gradient(145deg, #f0fff4, #e8f5e8);
        box-shadow: 0 8px 25px rgba(39, 174, 96, 0.15);
      }

      .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .appointment-date {
        font-weight: 700;
        color: #2c3e50;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .appointment-time {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      .appointment-details {
        margin-bottom: 12px;
      }

      .appointment-details p {
        margin: 6px 0;
        color: #555;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .status-booked {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        color: #1565c0;
        border: 1px solid rgba(21, 101, 192, 0.2);
      }

      .status-completed {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        color: #2e7d32;
        border: 1px solid rgba(46, 125, 50, 0.2);
      }

      .status-cancelled {
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        color: #c62828;
        border: 1px solid rgba(198, 40, 40, 0.2);
      }

      .prescription-text {
        background: linear-gradient(145deg, #f0f8ff, #e1f5fe);
        padding: 12px;
        border-radius: 12px;
        border-left: 4px solid #2196f3;
        margin-top: 12px;
        font-style: italic;
        color: #1565c0;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-align: center;
        transition: all 0.3s ease;
        font-size: 0.85rem;
        font-weight: 600;
        margin: 5px;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, #27ae60, #229954);
        color: white;
        box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
      }

      .btn-success:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(39, 174, 96, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
      }

      .btn-danger:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        color: white;
        box-shadow: 0 6px 20px rgba(149, 165, 166, 0.3);
      }

      .btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(149, 165, 166, 0.4);
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 0.8rem;
      }

      .form-group {
        margin-bottom: 18px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.95rem;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e6ed;
        border-radius: 12px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 15px rgba(52, 152, 219, 0.2);
        background: white;
        transform: translateY(-2px);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .modal-content {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        margin: 30px auto;
        padding: 35px;
        border-radius: 25px;
        max-width: 700px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 18px;
        border-bottom: 2px solid #e9ecef;
      }

      .modal-header h3 {
        color: #2c3e50;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #aaa;
        transition: all 0.3s ease;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #f8f9fa;
      }

      .close:hover {
        color: #e74c3c;
        background: #ffebee;
        transform: scale(1.1);
      }

      .slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 12px;
        margin: 16px 0;
      }

      .slot-btn {
        padding: 12px;
        border: 2px solid #e0e6ed;
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        border-radius: 12px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s ease;
        font-weight: 600;
        position: relative;
        overflow: hidden;
        font-size: 0.85rem;
      }

      .slot-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, transparent 30%, rgba(52, 152, 219, 0.1) 50%, transparent 70%);
        transform: translateX(-100%);
        transition: transform 0.5s ease;
      }

      .slot-btn:hover::before {
        transform: translateX(100%);
      }

      .slot-btn:hover {
        background: linear-gradient(145deg, #f0f8ff, #e3f2fd);
        border-color: #3498db;
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(52, 152, 219, 0.2);
      }

      .slot-btn.selected {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border-color: #2980b9;
        box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        transform: translateY(-3px);
      }

      .slot-btn:disabled {
        background: #f5f5f5;
        color: #999;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .upload-section {
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        padding: 22px;
        border-radius: 20px;
        margin-bottom: 25px;
        border: 3px dashed #cbd5e0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .upload-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, transparent 40%, rgba(52, 152, 219, 0.05) 50%, transparent 60%);
        transform: translateX(-100%);
        transition: transform 0.8s ease;
      }

      .upload-section:hover::before {
        transform: translateX(100%);
      }

      .upload-section:hover {
        border-color: #3498db;
        background: linear-gradient(145deg, #f0f8ff, #e3f2fd);
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(52, 152, 219, 0.1);
      }

      .upload-section h4 {
        color: #2c3e50;
        margin-bottom: 18px;
        font-size: 1.2rem;
        font-weight: 700;
      }

      .documents-list {
        margin-top: 25px;
      }

      .documents-list h4 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.2rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .document-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border: 1px solid #e0e6ed;
        border-radius: 15px;
        margin-bottom: 12px;
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .document-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.05), transparent);
        transition: left 0.5s ease;
      }

      .document-item:hover::before {
        left: 100%;
      }

      .document-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        border-color: #3498db;
      }

      .doc-info {
        flex: 1;
      }

      .doc-info strong {
        color: #2c3e50;
        display: block;
        margin-bottom: 6px;
        font-size: 1.1rem;
        font-weight: 700;
      }

      .doc-info p {
        margin: 5px 0;
        color: #666;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .doc-info small {
        display: block;
        color: #888;
        margin-top: 6px;
        font-style: italic;
        font-size: 0.85rem;
      }

      .doc-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .doc-type-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        margin-left: 12px;
        letter-spacing: 0.5px;
      }

      .doc-type-lab {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        color: #1565c0;
        border: 1px solid rgba(21, 101, 192, 0.2);
      }

      .doc-type-scan {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        color: #ef6c00;
        border: 1px solid rgba(239, 108, 0, 0.2);
      }

      .doc-type-prescription {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        color: #2e7d32;
        border: 1px solid rgba(46, 125, 50, 0.2);
      }

      .doc-type-other {
        background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        color: #7b1fa2;
        border: 1px solid rgba(123, 31, 162, 0.2);
      }

      .loading {
        text-align: center;
        padding: 30px 16px;
        color: #666;
        font-size: 1rem;
        font-weight: 500;
      }

      .loading::before {
        content: '';
        display: inline-block;
        width: 26px;
        height: 26px;
        border: 3px solid #e0e6ed;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 12px;
        vertical-align: middle;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .no-data {
        text-align: center;
        padding: 30px;
        color: #999;
        font-style: italic;
        font-size: 1rem;
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        border: 2px dashed #dee2e6;
      }

      .error-message {
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        color: #c62828;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        border-left: 4px solid #f44336;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.2);
        font-size: 0.9rem;
      }

      .success-message {
        background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        color: #2e7d32;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        border-left: 4px solid #4caf50;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
        font-size: 0.9rem;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      /* Enhanced Chatbot Styles */
      #chatbotBtn {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 55px;
        height: 55px;
        font-size: 22px;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        z-index: 9999;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #chatbotBtn:hover {
        transform: scale(1.1);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.6);
      }

      #chatWindow {
        position: fixed;
        bottom: 90px;
        right: 25px;
        width: 300px;
        height: 420px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        display: none;
        flex-direction: column;
        overflow: hidden;
        z-index: 9999;
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 16px;
        text-align: center;
        font-weight: 600;
        font-size: 1rem;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      #chatMessages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        font-size: 13px;
        background: linear-gradient(145deg, #fafbff, #f0f4f8);
        scrollbar-width: thin;
        scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
      }

      #chatMessages::-webkit-scrollbar {
        width: 5px;
      }

      #chatMessages::-webkit-scrollbar-track {
        background: transparent;
      }

      #chatMessages::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 3px;
      }

      .msg-user {
        text-align: right;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 10px 15px;
        border-radius: 18px 18px 5px 18px;
        margin: 8px 0;
        margin-left: 18%;
        white-space: pre-wrap;
        box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
        word-wrap: break-word;
        font-weight: 500;
        position: relative;
      }

      .msg-bot {
        text-align: left;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        color: #333;
        padding: 10px 15px;
        border-radius: 18px 18px 18px 5px;
        margin: 8px 0;
        margin-right: 18%;
        white-space: pre-wrap;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
        word-wrap: break-word;
        position: relative;
      }

      .msg-bot::before {
        content: 'ü§ñ';
        position: absolute;
        left: -6px;
        top: -6px;
        background: #e8f5e8;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .msg-user::after {
        content: 'üë§';
        position: absolute;
        right: -6px;
        top: -6px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .empty-chat-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: #666;
        padding: 30px 16px;
      }

      .empty-chat-state h4 {
        margin-bottom: 8px;
        font-size: 1.1rem;
        color: #2c3e50;
      }

      .empty-chat-state p {
        font-size: 0.9rem;
        opacity: 0.8;
        line-height: 1.4;
      }

      #chatInput {
        display: flex;
        align-items: center;
        padding: 14px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        gap: 10px;
      }

      #chatInput input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e0e6ed;
        border-radius: 20px;
        outline: none;
        background: #f8f9fa;
        font-size: 13px;
        font-family: inherit;
        transition: all 0.3s ease;
      }

      #chatInput input:focus {
        border-color: #667eea;
        box-shadow: 0 0 12px rgba(102, 126, 234, 0.2);
        background: white;
      }

      #chatInput input::placeholder {
        color: #999;
      }

      #chatInput button {
        padding: 12px 16px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
        font-size: 13px;
      }

      #chatInput button:hover {
        background: linear-gradient(135deg, #5a67d8, #6b46c1);
        transform: translateY(-2px);
        box-shadow: 0 5px 16px rgba(102, 126, 234, 0.4);
      }

      .typing-indicator {
        display: none;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 10px 15px;
        border-radius: 18px 18px 18px 5px;
        margin: 8px 0;
        margin-right: 18%;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
        font-style: italic;
        color: #666;
        position: relative;
      }

      .typing-indicator::before {
        content: 'ü§ñ';
        position: absolute;
        left: -6px;
        top: -6px;
        background: #e8f5e8;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .typing-dots {
        display: inline-block;
        animation: typingAnimation 1.5s infinite;
      }

      @keyframes typingAnimation {
        0%, 60%, 100% {
          opacity: 1;
        }
        30% {
          opacity: 0.3;
        }
      }

      /* Mobile responsive */
      @media (max-width: 968px) {
        .container {
          margin: 10px;
          border-radius: 20px;
        }

        .main-content {
          padding: 20px;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .header {
          padding: 25px 18px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .nav-bar {
          padding: 12px 18px;
          flex-direction: column;
          gap: 12px;
        }

        .nav-links {
          gap: 12px;
          flex-wrap: wrap;
          justify-content: center;
        }

        .appointment-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .document-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }

        .doc-actions {
          width: 100%;
          justify-content: center;
        }

        #chatWindow {
          bottom: 75px;
          right: 12px;
          left: 12px;
          width: auto;
          height: 380px;
        }

        #chatbotBtn {
          bottom: 18px;
          right: 18px;
          width: 50px;
          height: 50px;
          font-size: 1.3rem;
        }

        .modal-content {
          margin: 16px;
          padding: 25px;
        }

        .section {
          padding: 18px;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 8px;
        }

        .header h1 {
          font-size: 1.8rem;
        }

        .section {
          padding: 16px;
        }

        .modal-content {
          margin: 12px;
          padding: 20px;
        }

        .btn {
          padding: 8px 16px;
          font-size: 0.8rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
          padding: 10px;
        }

        .slots-grid {
          grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
          gap: 8px;
        }

        .slot-btn {
          padding: 10px;
          font-size: 0.8rem;
        }
      }

      /* Enhanced scrollbar for all containers */
      .section {
        scrollbar-width: thin;
        scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
      }

      .section::-webkit-scrollbar {
        width: 5px;
      }

      .section::-webkit-scrollbar-track {
        background: transparent;
      }

      .section::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 3px;
      }

      /* Smooth page transitions */
      .fade-in {
        animation: fadeInUp 0.6s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container fade-in">
      <div class="header">
        <h1>üè• Patient Dashboard</h1>
        <p>Welcome back, <span id="patientName">Patient</span></p>
      </div>

      <div class="nav-bar">
        <div class="nav-links">
          <a href="#appointments"><i class="fas fa-calendar-alt"></i> üìÖ Appointments</a>
          <a href="#documents"><i class="fas fa-file-medical"></i> üìÑ Documents</a>
          <a href="#book-appointment"><i class="fas fa-plus"></i> ‚ûï Book New</a>
        </div>
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> üö™ Logout</button>
      </div>

      <div class="main-content">
        <!-- Today's and Upcoming Appointments -->
        <div class="dashboard-grid">
          <div class="section fade-in">
            <h3><i class="fas fa-calendar-day"></i> üìÖ Today's Appointments</h3>
            <div id="todayAppointments">
              <div class="loading">Loading appointments...</div>
            </div>
          </div>

          <div class="section fade-in">
            <h3><i class="fas fa-calendar-plus"></i> üìã Upcoming Appointments</h3>
            <div id="upcomingAppointments">
              <div class="loading">Loading appointments...</div>
            </div>
          </div>
        </div>

        <!-- Past Appointments & Prescriptions -->
        <div class="section fade-in">
          <h3><i class="fas fa-history"></i> üìú Past Appointments & Prescriptions</h3>
          <div id="pastAppointments">
            <div class="loading">Loading past appointments...</div>
          </div>
        </div>

        <!-- Document Management -->
        <div class="section full-width fade-in">
          <h3><i class="fas fa-file-medical"></i> üìÑ Medical Documents</h3>

          <!-- Upload Section -->
          <div class="upload-section">
            <h4><i class="fas fa-cloud-upload-alt"></i> üì§ Upload New Document</h4>
            <form id="documentUploadForm" enctype="multipart/form-data">
              <div class="form-group">
                <label><i class="fas fa-paperclip"></i> üìé Select Document:</label>
                <input
                  type="file"
                  id="documentFile"
                  accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.txt"
                  required
                />
              </div>
              <div class="form-group">
                <label><i class="fas fa-list"></i> üìã Document Type:</label>
                <select id="docType" required>
                  <option value="">Select type...</option>
                  <option value="lab">üß™ Lab Report</option>
                  <option value="scan">üì± Scan/X-ray</option>
                  <option value="prescription">üíä Prescription</option>
                  <option value="other">üìÑ Other</option>
                </select>
              </div>
              <div class="form-group">
                <label><i class="fas fa-edit"></i> üìù Description (optional):</label>
                <input
                  type="text"
                  id="docDescription"
                  placeholder="Brief description of the document"
                />
              </div>
              <div class="form-group">
                <label><i class="fas fa-hospital"></i> üè• Link to Appointment (optional):</label>
                <select id="appointmentLink">
                  <option value="">No specific appointment</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-upload"></i> üì§ Upload Document
              </button>
            </form>
          </div>

          <!-- Documents List -->
          <div class="documents-list">
            <h4><i class="fas fa-folder-open"></i> üìã All My Documents</h4>
            <div id="documentsContainer">
              <div class="loading">Loading documents...</div>
            </div>
          </div>
        </div>

        <!-- Prescriptions Section -->
        <div class="section full-width fade-in">
          <h3><i class="fas fa-pills"></i> üíä My Prescriptions</h3>
          <div id="prescriptionsContainer">
            <div class="loading">Loading prescriptions...</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="section fade-in">
          <h3><i class="fas fa-bolt"></i> ‚ö° Quick Actions</h3>
          <div style="display: flex; gap: 15px; flex-wrap: wrap">
            <button class="btn btn-primary" onclick="openBookingModal()">
              <i class="fas fa-calendar-plus"></i> üìÖ Book Appointment
            </button>
            <button class="btn btn-success" onclick="refreshDashboard()">
              <i class="fas fa-sync-alt"></i> üîÑ Refresh Dashboard
            </button>
            <button class="btn btn-secondary" onclick="openChatbot()">
              <i class="fas fa-comments"></i> üí¨ AI Health Chat
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Book Appointment Modal -->
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-calendar-plus"></i> üìÖ Book New Appointment</h3>
          <span class="close" onclick="closeBookingModal()">&times;</span>
        </div>

        <form id="bookingForm">
          <div class="form-group">
            <label><i class="fas fa-hospital"></i> üè• Filter by Specialization:</label>
            <select id="specializationFilter">
              <option value="">All Specializations</option>
            </select>
          </div>

          <div class="form-group">
            <label><i class="fas fa-user-md"></i> üë®‚Äç‚öïÔ∏è Select Doctor:</label>
            <select id="doctorSelect" required>
              <option value="">Choose a doctor...</option>
            </select>
          </div>

          <div class="form-group">
            <label><i class="fas fa-calendar-alt"></i> üìÖ Select Date:</label>
            <input type="date" id="appointmentDate" required />
          </div>

          <div class="form-group">
            <label><i class="fas fa-clock"></i> ‚è∞ Available Slots:</label>
            <div id="slotsContainer">
              <p class="no-data">Please select a doctor and date first</p>
            </div>
          </div>

          <div id="bookingMessages"></div>

          <div
            style="
              display: flex;
              gap: 15px;
              justify-content: flex-end;
              margin-top: 25px;
            "
          >
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeBookingModal()"
            >
              <i class="fas fa-times"></i> ‚ùå Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check"></i> ‚úÖ Book Appointment
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Update Appointment Modal -->
    <div id="updateModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-edit"></i> ‚úèÔ∏è Update Appointment</h3>
          <span class="close" onclick="closeUpdateModal()">&times;</span>
        </div>

        <form id="updateForm">
          <input type="hidden" id="updateAppointmentId" />

          <div class="form-group">
            <label><i class="fas fa-user-md"></i> üë®‚Äç‚öïÔ∏è Select New Doctor (optional):</label>
            <select id="updateDoctorSelect">
              <option value="">Keep current doctor</option>
            </select>
          </div>

          <div class="form-group">
            <label><i class="fas fa-calendar-alt"></i> üìÖ Select New Date:</label>
            <input type="date" id="updateAppointmentDate" required />
          </div>

          <div class="form-group">
            <label><i class="fas fa-clock"></i> ‚è∞ Available Slots:</label>
            <div id="updateSlotsContainer">
              <p class="no-data">Please select date and doctor first</p>
            </div>
          </div>

          <div id="updateMessages"></div>

          <div
            style="
              display: flex;
              gap: 15px;
              justify-content: flex-end;
              margin-top: 25px;
            "
          >
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeUpdateModal()"
            >
              <i class="fas fa-times"></i> ‚ùå Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check"></i> ‚úÖ Update Appointment
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Enhanced Chatbot -->
    <button id="chatbotBtn" title="AI Health Assistant">üí¨</button>
    <div id="chatWindow">
      <div class="chat-header">
        ü§ñ AI Health Assistant
      </div>
      <div id="chatMessages">
        <div class="empty-chat-state">
          <div style="font-size: 2.5rem; margin-bottom: 16px; color: #667eea;">ü©∫</div>
          <h4>AI Health Assistant</h4>
          <p>Hello! I'm here to help you with health queries, appointment information, and wellness insights.</p>
        </div>
      </div>
      <div id="chatInput">
        <input
          type="text"
          id="chatText"
          placeholder="Ask about health conditions, symptoms, medications..."
        />
        <button id="chatSend">
          <span>Send</span>
          <i class="fas fa-paper-plane" style="margin-left: 4px;"></i>
        </button>
      </div>
    </div>

    <script>
      let currentUser = null;
      let allAppointments = [];
      let allDoctors = [];
      let selectedSlot = null;
      let updateSelectedSlot = null;

      // Chatbot functionality
      let chatbotOpen = false;
      let chatHistory = [];

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        loadDashboard();
        setupEventListeners();
        setMinDate();
        setupChatbot();
      });

      function checkAuth() {
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");

        if (!token || role !== "patient") {
          window.location.href = "/frontend/login.html";
          return;
        }
      }

      function setMinDate() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("appointmentDate").min = today;
        document.getElementById("updateAppointmentDate").min = today;
      }

      function setupEventListeners() {
        // Document upload form
        document
          .getElementById("documentUploadForm")
          .addEventListener("submit", handleDocumentUpload);

        // Booking form
        document
          .getElementById("bookingForm")
          .addEventListener("submit", handleBooking);

        // Update form
        document
          .getElementById("updateForm")
          .addEventListener("submit", handleUpdate);

        // Specialization filter
        document
          .getElementById("specializationFilter")
          .addEventListener("change", filterDoctors);

        // Doctor selection for booking
        document
          .getElementById("doctorSelect")
          .addEventListener("change", loadAvailableSlots);
        document
          .getElementById("appointmentDate")
          .addEventListener("change", loadAvailableSlots);

        // Doctor selection for updating
        document
          .getElementById("updateDoctorSelect")
          .addEventListener("change", loadUpdateSlots);
        document
          .getElementById("updateAppointmentDate")
          .addEventListener("change", loadUpdateSlots);
      }

      function setupChatbot() {
        // Setup click handler for send button (NOT submit)
        document
          .getElementById("chatbotSendBtn")
          .addEventListener("click", sendChatMessage);

        // Auto-resize textarea
        const textarea = document.getElementById("chatbotInput");
        textarea.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 100) + "px";
        });

        // Enter to send (Shift+Enter for new line)
        textarea.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
          }
        });

        // Close on outside click
        document
          .getElementById("chatbotModal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeChatbot();
            }
          });
      }

      async function loadDashboard() {
        await Promise.all([
          loadPatientDashboard(),
          loadSpecializations(),
          loadDoctors(),
          loadPatientDocuments(),
          loadPatientPrescriptions(),
        ]);
      }

      async function loadPatientDashboard() {
        try {
          const response = await fetch("/api/patient/dashboard/", {
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            displayDashboardData(data);
            populateAppointmentDropdown(data.upcoming.concat(data.past));
          } else {
            throw new Error("Failed to load dashboard");
          }
        } catch (error) {
          console.error("Error loading dashboard:", error);
          showMessage("Error loading dashboard data", "error");
        }
      }

      function displayDashboardData(data) {
        document.getElementById("patientName").textContent = data.patient_name;

        // Today's appointments
        displayAppointments(data.today, "todayAppointments", true);

        // Upcoming appointments
        displayAppointments(data.upcoming, "upcomingAppointments");

        // Past appointments
        displayAppointments(data.past, "pastAppointments", false, true);

        allAppointments = [...data.today, ...data.upcoming, ...data.past];
      }

      function displayAppointments(
        appointments,
        containerId,
        isToday = false,
        showPrescription = false
      ) {
        const container = document.getElementById(containerId);

        if (!appointments || appointments.length === 0) {
          container.innerHTML =
            '<div class="no-data">No appointments found</div>';
          return;
        }

        container.innerHTML = appointments
          .map(
            (apt) => `
                    <div class="appointment-card ${isToday ? "today" : ""} ${
              apt.status === "completed" ? "completed" : ""
            }">
                        <div class="appointment-header">
                            <span class="appointment-date"><i class="fas fa-calendar"></i> üìÖ ${formatDate(
                              apt.date
                            )}</span>
                            <span class="appointment-time"><i class="fas fa-clock"></i> ‚è∞ ${apt.time}</span>
                        </div>
                        <div class="appointment-details">
                            <p><strong><i class="fas fa-user-md"></i> üë®‚Äç‚öïÔ∏è Doctor:</strong> ${
                              apt.doctor_name
                            }</p>
                            <p><strong><i class="fas fa-hospital"></i> üè• Specialization:</strong> ${
                              apt.specialization || "General"
                            }</p>
                            <p><strong><i class="fas fa-info-circle"></i> üìä Status:</strong> <span class="status-badge status-${
                              apt.status
                            }">${apt.status}</span></p>
                            ${
                              showPrescription && apt.prescription
                                ? `
                                <div class="prescription-text">
                                    <strong><i class="fas fa-pills"></i> üíä Prescription:</strong><br>
                                    ${apt.prescription}
                                </div>
                            `
                                : ""
                            }
                        </div>
                        ${
                          apt.status === "booked" && !isToday
                            ? `
                            <div style="margin-top: 12px;">
                                <button class="btn btn-primary btn-small" onclick="openUpdateModal(${apt.id})"><i class="fas fa-edit"></i> ‚úèÔ∏è Update</button>
                                <button class="btn btn-danger btn-small" onclick="cancelAppointment(${apt.id})"><i class="fas fa-times"></i> ‚ùå Cancel</button>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `
          )
          .join("");
      }

      async function loadPatientDocuments() {
        try {
          const response = await fetch("/api/my-documents/", {
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const documents = await response.json();
            displayDocuments(documents);
          } else {
            document.getElementById("documentsContainer").innerHTML =
              '<div class="no-data">No documents found</div>';
          }
        } catch (error) {
          console.error("Error loading documents:", error);
          document.getElementById("documentsContainer").innerHTML =
            '<div class="error-message">Error loading documents</div>';
        }
      }

      function displayDocuments(documents) {
        const container = document.getElementById("documentsContainer");

        if (!documents || documents.length === 0) {
          container.innerHTML =
            '<div class="no-data"><i class="fas fa-file"></i> üìÑ No documents uploaded yet</div>';
          return;
        }

        container.innerHTML = documents
          .map(
            (doc) => `
                    <div class="document-item">
                        <div class="doc-info">
                            <strong>
                                ${getDocumentIcon(doc.doc_type)} ${doc.doc_type}
                                <span class="doc-type-badge doc-type-${doc.doc_type.toLowerCase()}">${
              doc.doc_type
            }</span>
                            </strong>
                            ${
                              doc.description
                                ? `<p><i class="fas fa-edit"></i> üìù ${doc.description}</p>`
                                : ""
                            }
                            <small><i class="fas fa-calendar"></i> üìÖ Uploaded: ${formatDateTime(
                              doc.uploaded_at
                            )}</small>
                            ${
                              doc.doctor_name
                                ? `<small><i class="fas fa-user-md"></i> üë®‚Äç‚öïÔ∏è Associated Doctor: ${doc.doctor_name}</small>`
                                : ""
                            }
                            ${
                              doc.file_name
                                ? `<small><i class="fas fa-paperclip"></i> üìé File: ${doc.file_name}</small>`
                                : ""
                            }
                        </div>
                        <div class="doc-actions">
                            <a href="${
                              doc.file_url
                            }" target="_blank" class="btn btn-primary btn-small"><i class="fas fa-eye"></i> üëÅÔ∏è View</a>
                            <a href="${doc.file_url}" download="${
              doc.file_name || "document"
            }" class="btn btn-secondary btn-small"><i class="fas fa-download"></i> üì• Download</a>
                        </div>
                    </div>
                `
          )
          .join("");
      }

      function getDocumentIcon(type) {
        const icons = {
          lab: "üß™",
          scan: "üì±",
          prescription: "üíä",
          other: "üìÑ",
        };
        return icons[type.toLowerCase()] || "üìÑ";
      }

      async function handleDocumentUpload(e) {
        e.preventDefault();

        const fileInput = document.getElementById("documentFile");
        const docType = document.getElementById("docType").value;
        const description = document.getElementById("docDescription").value;
        const appointmentId = document.getElementById("appointmentLink").value;

        if (!fileInput.files[0]) {
          showMessage("Please select a file", "error");
          return;
        }

        if (!docType) {
          showMessage("Please select a document type", "error");
          return;
        }

        const formData = new FormData();
        formData.append("document", fileInput.files[0]);
        formData.append("doc_type", docType);
        formData.append("description", description);
        if (appointmentId) {
          formData.append("appointment_id", appointmentId);
        }

        try {
          const response = await fetch("/api/documents/upload/", {
            method: "POST",
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
            },
            body: formData,
          });

          if (response.ok) {
            const result = await response.json();
            showMessage("üì§ Document uploaded successfully!", "success");

            // Reset form
            e.target.reset();

            // Reload documents
            await loadPatientDocuments();
          } else {
            const error = await response.json();
            showMessage(
              "Upload failed: " + (error.error || "Unknown error"),
              "error"
            );
          }
        } catch (error) {
          console.error("Upload error:", error);
          showMessage("Upload failed: " + error.message, "error");
        }
      }

      function populateAppointmentDropdown(appointments) {
        const select = document.getElementById("appointmentLink");

        select.innerHTML =
          '<option value="">No specific appointment</option>' +
          appointments
            .map(
              (apt) => `
                        <option value="${apt.id}">
                            ${formatDate(apt.date)} ${apt.time} - Dr. ${
                apt.doctor_name
              }
                        </option>
                    `
            )
            .join("");
      }

      async function loadSpecializations() {
        try {
          const response = await fetch("/api/doctors/specializations/", {
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            const specializations = await response.json();
            populateSpecializations(specializations);
          }
        } catch (error) {
          console.error("Error loading specializations:", error);
        }
      }

      function populateSpecializations(specializations) {
        const select = document.getElementById("specializationFilter");
        select.innerHTML =
          '<option value="">All Specializations</option>' +
          specializations
            .map((spec) => `<option value="${spec}">${spec}</option>`)
            .join("");
      }

      async function loadDoctors() {
        try {
          const response = await fetch("/api/doctors/", {
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            allDoctors = await response.json();
            populateDoctorSelects();
          }
        } catch (error) {
          console.error("Error loading doctors:", error);
        }
      }

      function populateDoctorSelects() {
        const bookingSelect = document.getElementById("doctorSelect");
        const updateSelect = document.getElementById("updateDoctorSelect");

        const doctorOptions = allDoctors
          .map(
            (doc) =>
              `<option value="${doc.id}">${doc.username} - ${doc.specialization}</option>`
          )
          .join("");

        bookingSelect.innerHTML =
          '<option value="">Choose a doctor...</option>' + doctorOptions;
        updateSelect.innerHTML =
          '<option value="">Keep current doctor</option>' + doctorOptions;
      }

      function filterDoctors() {
        const specialization = document.getElementById(
          "specializationFilter"
        ).value;
        const doctorSelect = document.getElementById("doctorSelect");

        let filteredDoctors = allDoctors;
        if (specialization) {
          filteredDoctors = allDoctors.filter((doc) =>
            doc.specialization
              .toLowerCase()
              .includes(specialization.toLowerCase())
          );
        }

        doctorSelect.innerHTML =
          '<option value="">Choose a doctor...</option>' +
          filteredDoctors
            .map(
              (doc) =>
                `<option value="${doc.id}">${doc.username} - ${doc.specialization}</option>`
            )
            .join("");

        // Clear slots when filter changes
        document.getElementById("slotsContainer").innerHTML =
          '<p class="no-data">Please select a doctor and date first</p>';
        selectedSlot = null;
      }

      async function loadAvailableSlots() {
        const doctorId = document.getElementById("doctorSelect").value;
        const date = document.getElementById("appointmentDate").value;

        if (!doctorId || !date) {
          document.getElementById("slotsContainer").innerHTML =
            '<p class="no-data">Please select both doctor and date</p>';
          return;
        }

        try {
          const response = await fetch(
            `/api/slots/?doctor_id=${doctorId}&date=${date}`,
            {
              headers: {
                Authorization: `Token ${localStorage.getItem("token")}`,
              },
            }
          );

          if (response.ok) {
            const slots = await response.json();
            displaySlots(slots, "slotsContainer", "booking");
          } else {
            document.getElementById("slotsContainer").innerHTML =
              '<p class="error-message">Error loading slots</p>';
          }
        } catch (error) {
          console.error("Error loading slots:", error);
          document.getElementById("slotsContainer").innerHTML =
            '<p class="error-message">Error loading slots</p>';
        }
      }

      async function loadUpdateSlots() {
        const doctorId = document.getElementById("updateDoctorSelect").value;
        const date = document.getElementById("updateAppointmentDate").value;

        if (!date) {
          document.getElementById("updateSlotsContainer").innerHTML =
            '<p class="no-data">Please select a date</p>';
          return;
        }

        // Use current doctor if no new doctor selected
        const currentAppointment = allAppointments.find(
          (apt) =>
            apt.id ===
            parseInt(document.getElementById("updateAppointmentId").value)
        );

        const finalDoctorId =
          doctorId || (currentAppointment ? currentAppointment.doctor : null);

        if (!finalDoctorId) {
          document.getElementById("updateSlotsContainer").innerHTML =
            '<p class="no-data">Please select date and doctor</p>';
          return;
        }

        try {
          const response = await fetch(
            `/api/slots/?doctor_id=${finalDoctorId}&date=${date}`,
            {
              headers: {
                Authorization: `Token ${localStorage.getItem("token")}`,
              },
            }
          );

          if (response.ok) {
            const slots = await response.json();
            displaySlots(slots, "updateSlotsContainer", "update");
          } else {
            document.getElementById("updateSlotsContainer").innerHTML =
              '<p class="error-message">Error loading slots</p>';
          }
        } catch (error) {
          console.error("Error loading slots:", error);
          document.getElementById("updateSlotsContainer").innerHTML =
            '<p class="error-message">Error loading slots</p>';
        }
      }

      function displaySlots(slots, containerId, type) {
        const container = document.getElementById(containerId);

        if (!slots || slots.length === 0) {
          container.innerHTML =
            '<p class="no-data">No available slots for this date</p>';
          return;
        }

        container.innerHTML = `
                    <div class="slots-grid">
                        ${slots
                          .map(
                            (slot) => `
                            <button type="button" class="slot-btn" onclick="selectSlot('${slot}', '${type}')">
                                <i class="fas fa-clock"></i> ${slot}
                            </button>
                        `
                          )
                          .join("")}
                    </div>
                `;
      }

      function selectSlot(slot, type) {
        if (type === "booking") {
          // Remove previous selection
          document
            .querySelectorAll("#slotsContainer .slot-btn")
            .forEach((btn) => {
              btn.classList.remove("selected");
            });

          // Add selection to clicked button
          event.target.classList.add("selected");
          selectedSlot = slot;
        } else if (type === "update") {
          // Remove previous selection
          document
            .querySelectorAll("#updateSlotsContainer .slot-btn")
            .forEach((btn) => {
              btn.classList.remove("selected");
            });

          // Add selection to clicked button
          event.target.classList.add("selected");
          updateSelectedSlot = slot;
        }
      }

      async function handleBooking(e) {
        e.preventDefault();

        const doctorId = document.getElementById("doctorSelect").value;
        const date = document.getElementById("appointmentDate").value;

        if (!doctorId || !date || !selectedSlot) {
          showMessage(
            "Please fill all fields and select a time slot",
            "error",
            "bookingMessages"
          );
          return;
        }

        try {
          const response = await fetch("/api/appointments/", {
            method: "POST",
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              doctor_id: doctorId,
              date: date,
              slot: selectedSlot,
            }),
          });

          if (response.ok) {
            const result = await response.json();
            showMessage(
              "‚úÖ Appointment booked successfully!",
              "success",
              "bookingMessages"
            );

            setTimeout(() => {
              closeBookingModal();
              refreshDashboard();
            }, 1500);
          } else {
            const error = await response.json();
            showMessage(
              "Booking failed: " + (error.error || "Unknown error"),
              "error",
              "bookingMessages"
            );
          }
        } catch (error) {
          console.error("Booking error:", error);
          showMessage(
            "Booking failed: " + error.message,
            "error",
            "bookingMessages"
          );
        }
      }

      async function handleUpdate(e) {
        e.preventDefault();

        const appointmentId = document.getElementById(
          "updateAppointmentId"
        ).value;
        const doctorId = document.getElementById("updateDoctorSelect").value;
        const date = document.getElementById("updateAppointmentDate").value;

        if (!date || !updateSelectedSlot) {
          showMessage(
            "Please select date and time slot",
            "error",
            "updateMessages"
          );
          return;
        }

        try {
          const updateData = {
            date: date,
            slot: updateSelectedSlot,
          };

          if (doctorId) {
            updateData.doctor_id = doctorId;
          }

          const response = await fetch(`/api/appointments/${appointmentId}/`, {
            method: "PATCH",
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updateData),
          });

          if (response.ok) {
            showMessage(
              "‚úÖ Appointment updated successfully!",
              "success",
              "updateMessages"
            );

            setTimeout(() => {
              closeUpdateModal();
              refreshDashboard();
            }, 1500);
          } else {
            const error = await response.json();
            showMessage(
              "Update failed: " + (error.error || "Unknown error"),
              "error",
              "updateMessages"
            );
          }
        } catch (error) {
          console.error("Update error:", error);
          showMessage(
            "Update failed: " + error.message,
            "error",
            "updateMessages"
          );
        }
      }

      async function cancelAppointment(appointmentId) {
        if (!confirm("Are you sure you want to cancel this appointment?")) {
          return;
        }

        try {
          const response = await fetch(`/api/appointments/${appointmentId}/`, {
            method: "DELETE",
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
            },
          });

          if (response.ok) {
            showMessage("‚úÖ Appointment cancelled successfully!", "success");
            refreshDashboard();
          } else {
            const error = await response.json();
            showMessage(
              "Cancellation failed: " + (error.error || "Unknown error"),
              "error"
            );
          }
        } catch (error) {
          console.error("Cancellation error:", error);
          showMessage("Cancellation failed: " + error.message, "error");
        }
      }

      function openBookingModal() {
        document.getElementById("bookingModal").style.display = "block";
        document.getElementById("bookingForm").reset();
        selectedSlot = null;
        document.getElementById("bookingMessages").innerHTML = "";
        document.getElementById("slotsContainer").innerHTML =
          '<p class="no-data">Please select a doctor and date first</p>';
      }

      function closeBookingModal() {
        document.getElementById("bookingModal").style.display = "none";
      }

      function openUpdateModal(appointmentId) {
        const appointment = allAppointments.find(
          (apt) => apt.id === appointmentId
        );
        if (!appointment) return;

        document.getElementById("updateAppointmentId").value = appointmentId;
        document.getElementById("updateAppointmentDate").value =
          appointment.date;
        document.getElementById("updateModal").style.display = "block";
        updateSelectedSlot = null;
        document.getElementById("updateMessages").innerHTML = "";
        document.getElementById("updateSlotsContainer").innerHTML =
          '<p class="no-data">Please select date and doctor first</p>';
      }

      function closeUpdateModal() {
        document.getElementById("updateModal").style.display = "none";
      }

      async function refreshDashboard() {
        showMessage("üîÑ Refreshing dashboard...", "success");
        await loadDashboard();
        showMessage("‚úÖ Dashboard refreshed!", "success");
      }

      async function loadPatientPrescriptions() {
        try {
          const response = await fetch("/api/my-prescriptions/", {
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            displayPrescriptions(data.prescriptions || []);
          } else {
            document.getElementById("prescriptionsContainer").innerHTML =
              '<div class="no-data">No prescriptions found</div>';
          }
        } catch (error) {
          console.error("Error loading prescriptions:", error);
          document.getElementById("prescriptionsContainer").innerHTML =
            '<div class="error-message">Error loading prescriptions</div>';
        }
      }

      function displayPrescriptions(prescriptions) {
        const container = document.getElementById("prescriptionsContainer");

        if (!prescriptions || prescriptions.length === 0) {
          container.innerHTML =
            '<div class="no-data"><i class="fas fa-pills"></i> üíä No prescriptions available yet</div>';
          return;
        }

        container.innerHTML = prescriptions
          .map(
            (prescription) => `
            <div class="document-item">
                <div class="doc-info">
                    <strong>
                        <i class="fas fa-pills"></i> üíä Prescription ${
                          prescription.type === "prescription_file"
                            ? "(File)"
                            : "(Text)"
                        }
                    </strong>
                    <p><i class="fas fa-calendar"></i> üìÖ Date: ${formatDate(prescription.date)}</p>
                    <p><i class="fas fa-user-md"></i> üë®‚Äç‚öïÔ∏è Doctor: ${prescription.doctor_name}</p>
                    ${
                      prescription.content
                        ? `
                        <div class="prescription-text" style="margin-top: 12px;">
                            ${prescription.content}
                        </div>
                    `
                        : ""
                    }
                    <small><i class="fas fa-calendar-plus"></i> üìÖ Added: ${formatDateTime(
                      prescription.created_at
                    )}</small>
                </div>
                <div class="doc-actions">
                    ${
                      prescription.file_url
                        ? `
                        <a href="${prescription.file_url}" target="_blank" class="btn btn-primary btn-small"><i class="fas fa-eye"></i> üëÅÔ∏è View File</a>
                        <a href="${prescription.file_url}" download class="btn btn-secondary btn-small"><i class="fas fa-download"></i> üì• Download</a>
                    `
                        : ""
                    }
                    ${
                      prescription.appointment_id
                        ? `
                        <button class="btn btn-secondary btn-small" onclick="viewAppointmentDetails(${prescription.appointment_id})"><i class="fas fa-info-circle"></i> üìã View Appointment</button>
                    `
                        : ""
                    }
                </div>
            </div>
        `
          )
          .join("");
      }

      function viewAppointmentDetails(appointmentId) {
        const appointment = allAppointments.find(
          (apt) => apt.id === appointmentId
        );
        if (appointment) {
          alert(
            `Appointment Details:\nDate: ${formatDate(
              appointment.date
            )}\nTime: ${appointment.time}\nDoctor: ${
              appointment.doctor_name
            }\nStatus: ${appointment.status}`
          );
        }
      }

      ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      const chatBtn = document.getElementById("chatbotBtn");
      const chatWin = document.getElementById("chatWindow");
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatText");
      const chatSend = document.getElementById("chatSend");
      let history = [];

      chatBtn.addEventListener("click", () => {
        chatWin.style.display =
          chatWin.style.display === "none" ? "flex" : "none";
        
        // Clear empty state when opening
        if (chatWin.style.display === "flex") {
          const emptyState = chatMessages.querySelector(".empty-chat-state");
          if (emptyState && chatMessages.children.length === 1) {
            // Keep empty state if no messages yet
          }
        }
      });

      function addMsg(text, sender) {
        // Remove empty state when first message is added
        const emptyState = chatMessages.querySelector(".empty-chat-state");
        if (emptyState) {
          emptyState.remove();
        }

        const div = document.createElement("div");
        div.className = sender === "user" ? "msg-user" : "msg-bot";
        div.textContent = text;
        div.style.position = "relative";
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendChat() {
        const text = chatInput.value.trim();
        if (!text) return;

        addMsg(text, "user");
        history.push({ role: "user", content: text });
        chatInput.value = "";

        // Show typing indicator
        const typingDiv = document.createElement("div");
        typingDiv.className = "typing-indicator";
        typingDiv.innerHTML = 'AI is typing<span class="typing-dots">...</span>';
        typingDiv.style.display = "block";
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const res = await fetch("https://hospital-management-1-4p47.onrender.com/api/chat/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Token ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ messages: history }),
          });

          // Remove typing indicator
          typingDiv.remove();

          const data = await res.json();
          if (res.ok && data.reply) {
            addMsg(data.reply, "bot");
            history.push({ role: "assistant", content: data.reply });
          } else {
            addMsg(data.detail || "Error: Unable to get response.", "bot");
          }
        } catch (error) {
          // Remove typing indicator
          typingDiv.remove();
          console.error("Chat error:", error);
          addMsg("Error: Could not connect to chatbot.", "bot");
        }
      }

      chatSend.addEventListener("click", sendChat);
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendChat();
      });

      function showMessage(message, type, containerId = null) {
        const className =
          type === "error" ? "error-message" : "success-message";
        const messageHtml = `<div class="${className}"><i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i> ${message}</div>`;

        if (containerId) {
          document.getElementById(containerId).innerHTML = messageHtml;
        } else {
          // Show global message
          const existingMessage = document.querySelector(".global-message");
          if (existingMessage) {
            existingMessage.remove();
          }

          const messageDiv = document.createElement("div");
          messageDiv.className = `global-message ${className}`;
          messageDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i> ${message}`;
          messageDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        max-width: 400px;
                        padding: 16px;
                        border-radius: 12px;
                        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                        backdrop-filter: blur(10px);
                        animation: slideInRight 0.3s ease;
                    `;

          document.body.appendChild(messageDiv);

          setTimeout(() => {
            messageDiv.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => messageDiv.remove(), 300);
          }, 5000);
        }
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function formatDateTime(dateTimeString) {
        const date = new Date(dateTimeString);
        return date.toLocaleString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          localStorage.removeItem("token");
          localStorage.removeItem("role");
          window.location.href = "/frontend/login.html";
        }
      }

      // Close modals when clicking outside
      window.onclick = function (event) {
        const bookingModal = document.getElementById("bookingModal");
        const updateModal = document.getElementById("updateModal");

        if (event.target === bookingModal) {
          closeBookingModal();
        }
        if (event.target === updateModal) {
          closeUpdateModal();
        }
      };

      // Close chatbot with Escape key
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && chatbotOpen) {
          closeChatbot();
        }
      });

      // Add CSS animations for message notifications
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideInRight {
          from {
            opacity: 0;
            transform: translateX(100%);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
        
        @keyframes slideOutRight {
          from {
            opacity: 1;
            transform: translateX(0);
          }
          to {
            opacity: 0;
            transform: translateX(100%);
          }
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
