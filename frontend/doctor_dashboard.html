<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Dashboard - Hospital Management</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* Enhanced Chatbot Styles Only */
      #chatbotBtn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        z-index: 9999;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #chatbotBtn:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
      }

      #chatWindow {
        position: fixed;
        bottom: 110px;
        right: 30px;
        width: 380px;
        height: 500px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        display: none;
        flex-direction: column;
        overflow: hidden;
        z-index: 9999;
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #chatWindow::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 20px 20px 0 0;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        text-align: center;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      #chatMessages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        font-size: 14px;
        background: linear-gradient(145deg, #fafbff, #f0f4f8);
        scrollbar-width: thin;
        scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
      }

      #chatMessages::-webkit-scrollbar {
        width: 6px;
      }

      #chatMessages::-webkit-scrollbar-track {
        background: transparent;
      }

      #chatMessages::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 3px;
      }

      .msg-user {
        text-align: right;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 12px 18px;
        border-radius: 20px 20px 5px 20px;
        margin: 10px 0;
        margin-left: 20%;
        white-space: pre-wrap;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        word-wrap: break-word;
        font-weight: 500;
      }

      .msg-bot {
        text-align: left;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        color: #333;
        padding: 12px 18px;
        border-radius: 20px 20px 20px 5px;
        margin: 10px 0;
        margin-right: 20%;
        white-space: pre-wrap;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        word-wrap: break-word;
        position: relative;
      }

      .msg-bot::before {
        content: 'ü§ñ';
        position: absolute;
        left: -8px;
        top: -8px;
        background: #e8f5e8;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .msg-user::after {
        content: 'üë§';
        position: absolute;
        right: -8px;
        top: -8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .empty-chat-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: #666;
        padding: 40px 20px;
      }

      .empty-chat-state i {
        font-size: 3rem;
        margin-bottom: 20px;
        color: #667eea;
        opacity: 0.6;
      }

      .empty-chat-state h4 {
        margin-bottom: 10px;
        font-size: 1.2rem;
        color: #2c3e50;
      }

      .empty-chat-state p {
        font-size: 0.95rem;
        opacity: 0.8;
        line-height: 1.4;
      }

      #chatInput {
        display: flex;
        align-items: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        gap: 12px;
      }

      #chatInput input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #e0e6ed;
        border-radius: 25px;
        outline: none;
        background: #f8f9fa;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.3s ease;
      }

      #chatInput input:focus {
        border-color: #667eea;
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        background: white;
      }

      #chatInput input::placeholder {
        color: #999;
      }

      #chatInput button {
        padding: 15px 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      #chatInput button:hover {
        background: linear-gradient(135deg, #5a67d8, #6b46c1);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .typing-indicator {
        display: none;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 12px 18px;
        border-radius: 20px 20px 20px 5px;
        margin: 10px 0;
        margin-right: 20%;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        font-style: italic;
        color: #666;
        position: relative;
      }

      .typing-indicator::before {
        content: 'ü§ñ';
        position: absolute;
        left: -8px;
        top: -8px;
        background: #e8f5e8;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .typing-dots {
        display: inline-block;
        animation: typingAnimation 1.5s infinite;
      }

      @keyframes typingAnimation {
        0%, 60%, 100% {
          opacity: 1;
        }
        30% {
          opacity: 0.3;
        }
      }

      /* Mobile responsive for chatbot */
      @media (max-width: 768px) {
        #chatbotBtn {
          bottom: 20px;
          right: 20px;
          width: 60px;
          height: 60px;
          font-size: 1.5rem;
        }

        #chatWindow {
          bottom: 90px;
          right: 15px;
          left: 15px;
          width: auto;
          height: 450px;
        }

        .msg-user, .msg-bot {
          font-size: 13px;
          padding: 10px 15px;
        }

        #chatInput {
          padding: 15px;
        }

        #chatInput input {
          padding: 12px 18px;
          font-size: 13px;
        }

        #chatInput button {
          padding: 12px 18px;
        }
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50, #3498db);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .nav-bar {
        background: #34495e;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-links {
        display: flex;
        gap: 20px;
      }

      .nav-links a {
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 5px;
        transition: background 0.3s;
      }

      .nav-links a:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .logout-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .logout-btn:hover {
        background: #c0392b;
      }

      .main-content {
        padding: 30px;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 25px;
        margin-bottom: 30px;
      }

      .section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .section h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.4em;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .appointment-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #3498db;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      .appointment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      .appointment-card.today {
        border-left-color: #e74c3c;
        background: #fff5f5;
      }

      .appointment-card.completed {
        border-left-color: #27ae60;
        background: #f0fff4;
      }

      .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .patient-name {
        font-weight: bold;
        color: #2c3e50;
        font-size: 1.1em;
      }

      .appointment-time {
        background: #3498db;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
      }

      .appointment-details {
        margin-bottom: 10px;
      }

      .appointment-details p {
        margin: 5px 0;
        color: #666;
        font-size: 0.9em;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }

      .status-booked {
        background: #e3f2fd;
        color: #1976d2;
      }

      .status-completed {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .status-cancelled {
        background: #ffebee;
        color: #c62828;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: all 0.3s;
        font-size: 0.9em;
        margin: 3px;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background: #2980b9;
      }

      .btn-success {
        background: #27ae60;
        color: white;
      }

      .btn-success:hover {
        background: #229954;
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn-secondary {
        background: #95a5a6;
        color: white;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .btn-small {
        padding: 5px 10px;
        font-size: 0.8em;
      }

      .patient-search {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .search-form {
        display: flex;
        gap: 15px;
        align-items: end;
      }

      .form-group {
        flex: 1;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #2c3e50;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1em;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-top: 4px solid #3498db;
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .no-data {
        text-align: center;
        padding: 30px;
        color: #999;
        font-style: italic;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #f44336;
      }

      .success-message {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #4caf50;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        background: white;
        margin: 50px auto;
        padding: 30px;
        border-radius: 10px;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }

      .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #aaa;
      }

      .close:hover {
        color: #000;
      }

      /* Chatbot Modal Styles */
      .chatbot-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
      }

      .chatbot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 400px;
        height: 600px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        max-height: 80vh;
      }

      .chatbot-header {
        background: linear-gradient(135deg, #2c3e50, #3498db);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chatbot-header h3 {
        margin: 0;
        font-size: 1.1em;
      }

      .chatbot-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5em;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s;
      }

      .chatbot-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .chatbot-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
        min-height: 300px;
      }

      .chat-message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .chat-message.user {
        flex-direction: row-reverse;
      }

      .chat-message-content {
        max-width: 75%;
        padding: 10px 12px;
        border-radius: 10px;
        line-height: 1.4;
        font-size: 0.9em;
      }

      .chat-message.user .chat-message-content {
        background: #3498db;
        color: white;
      }

      .chat-message.bot .chat-message-content {
        background: white;
        border: 1px solid #ddd;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .chat-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
        flex-shrink: 0;
      }

      .chat-message.user .chat-avatar {
        background: #3498db;
        color: white;
      }

      .chat-message.bot .chat-avatar {
        background: #e8f5e8;
        color: #27ae60;
      }

      .chatbot-input {
        padding: 15px;
        background: white;
        border-top: 1px solid #ddd;
      }

      .chatbot-input-form {
        display: flex;
        gap: 8px;
      }

      .chatbot-input-field {
        flex: 1;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 0.9em;
        resize: none;
        min-height: 40px;
        max-height: 100px;
      }

      .chatbot-input-field:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 3px rgba(52, 152, 219, 0.3);
      }

      .chatbot-send-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background 0.3s;
        align-self: flex-end;
        min-width: 60px;
      }

      .chatbot-send-btn:hover:not(:disabled) {
        background: #2980b9;
      }

      .chatbot-send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .chatbot-typing {
        display: none;
        padding: 8px 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-style: italic;
        color: #666;
        font-size: 0.9em;
        max-width: 75%;
      }

      .chatbot-typing-dots {
        display: inline-block;
        animation: chatTyping 1.5s infinite;
      }

      @keyframes chatTyping {
        0%,
        60%,
        100% {
          opacity: 1;
        }
        30% {
          opacity: 0.3;
        }
      }

      .chatbot-welcome {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .chatbot-welcome h4 {
        margin-bottom: 8px;
        color: #2c3e50;
        font-size: 1em;
      }

      .chatbot-welcome p {
        font-size: 0.9em;
        line-height: 1.4;
      }

      .chatbot-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #3498db, #2c3e50);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        transition: all 0.3s;
        z-index: 9999;
      }

      .chatbot-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
      }

      .chatbot-toggle.active {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }

      /* Mobile responsive */
      @media (max-width: 1024px) {
        .dashboard-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .search-form {
          flex-direction: column;
        }

        .appointment-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .chatbot-container {
          bottom: 10px;
          right: 10px;
          left: 10px;
          width: auto;
          height: 500px;
        }

        .chatbot-toggle {
          bottom: 15px;
          right: 15px;
        }

        .chat-message-content {
          max-width: 85%;
          font-size: 0.85em;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üë®‚Äç‚öïÔ∏è Doctor Dashboard</h1>
        <p>
          Welcome back, <span id="doctorName">Dr. Smith</span> -
          <span id="specialization">General Medicine</span>
        </p>
      </div>

      <div class="nav-bar">
        <div class="nav-links">
          <a href="#appointments">üìÖ Appointments</a>
          <a href="#patients">üë• Patients</a>
          <a href="#documents">üìÑ Documents</a>
          <a href="#ai-tools">ü§ñ AI Tools</a>
        </div>
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
      </div>

      <div class="main-content">
        <!-- Statistics -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="todayCount">0</div>
            <div class="stat-label">Today's Appointments</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="upcomingCount">0</div>
            <div class="stat-label">Upcoming Appointments</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalPatientsCount">0</div>
            <div class="stat-label">Total Patients</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="completedCount">0</div>
            <div class="stat-label">Completed Today</div>
          </div>
        </div>

        <!-- Patient Search -->
        <div class="patient-search">
          <h3>üîç Search Patient Records</h3>
          <div class="search-form">
            <div class="form-group">
              <label>Patient Username:</label>
              <input
                type="text"
                id="patientSearch"
                placeholder="Enter patient username"
              />
            </div>
            <button class="btn btn-primary" onclick="searchPatient()">
              üîç Search Patient
            </button>
            <button class="btn btn-secondary" onclick="clearSearch()">
              üóëÔ∏è Clear
            </button>
          </div>
        </div>

        <!-- Appointments Grid -->
        <div class="dashboard-grid">
          <!-- Today's Appointments -->
          <div class="section">
            <h3>üìÖ Today's Appointments</h3>
            <div id="todayAppointments">
              <div class="loading">Loading today's appointments...</div>
            </div>
          </div>

          <!-- Upcoming Appointments -->
          <div class="section">
            <h3>üìã Upcoming Appointments</h3>
            <div id="upcomingAppointments">
              <div class="loading">Loading upcoming appointments...</div>
            </div>
          </div>

          <!-- Past Appointments -->
          <div class="section">
            <h3>üìú Recent Past Appointments</h3>
            <div id="pastAppointments">
              <div class="loading">Loading past appointments...</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="section">
          <h3>‚ö° Quick Actions</h3>
          <div style="display: flex; gap: 15px; flex-wrap: wrap">
            <button class="btn btn-primary" onclick="refreshDashboard()">
              üîÑ Refresh Dashboard
            </button>
            <button class="btn btn-success" onclick="viewAllDocuments()">
              üìÑ View All Documents
            </button>
            <button class="btn btn-secondary" onclick="openChatbot()">
              üí¨ AI Medical Assistant
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Chatbot -->
    <button id="chatbotBtn" title="AI Medical Assistant">üí¨</button>
    <div id="chatWindow">
      <div class="chat-header">
        ü§ñ AI Medical Assistant
      </div>
      <div id="chatMessages">
        <div class="empty-chat-state">
          <div style="font-size: 3rem; margin-bottom: 20px; color: #667eea;">ü©∫</div>
          <h4>AI Medical Assistant</h4>
          <p>Hello Doctor! I'm here to help you with medical queries, patient information, and clinical insights.</p>
        </div>
      </div>
      <div id="chatInput">
        <input
          type="text"
          id="chatText"
          placeholder="Ask about medical conditions, treatments, diagnoses..."
        />
        <button id="chatSend">
          <span>Send</span>
          <span style="margin-left: 5px;">üì®</span>
        </button>
      </div>
    </div>

    <script>
      let currentDoctor = null;
      let allAppointments = [];
      let currentPatient = null;

      // Chatbot functionality
      let chatbotOpen = false;

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        loadDoctorDashboard();
        setupEventListeners();
        setupChatbot();
      });

      function checkAuth() {
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");

        if (!token || role !== "doctor") {
          window.location.href = "/frontend/login.html";
          return;
        }
      }

      function setupEventListeners() {
        // Patient search
        document
          .getElementById("patientSearch")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              searchPatient();
            }
          });
      }

      function setupChatbot() {
        // Setup form handler
        document
          .getElementById("chatbotForm")
          .addEventListener("submit", handleChatbotMessage);

        // Auto-resize textarea
        const textarea = document.getElementById("chatbotInput");
        textarea.addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 100) + "px";
        });

        // Enter to send (Shift+Enter for new line)
        textarea.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            document
              .getElementById("chatbotForm")
              .dispatchEvent(new Event("submit"));
          }
        });

        // Close on outside click
        document
          .getElementById("chatbotModal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeChatbot();
            }
          });
      }

      async function loadDoctorDashboard() {
        try {
          const response = await fetch("/api/doctor/dashboard/", {
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const data = await response.json();
            displayDoctorData(data);
          } else {
            throw new Error("Failed to load dashboard");
          }
        } catch (error) {
          console.error("Error loading dashboard:", error);
          showMessage("Error loading dashboard data", "error");
        }
      }

      function displayDoctorData(data) {
        // Update doctor info
        document.getElementById("doctorName").textContent = data.doctor_name;
        document.getElementById("specialization").textContent =
          data.specialization;

        // Update statistics
        document.getElementById("todayCount").textContent = data.today.length;
        document.getElementById("upcomingCount").textContent =
          data.upcoming.length;
        document.getElementById("totalPatientsCount").textContent = new Set(
          [...data.today, ...data.upcoming, ...data.past].map(
            (apt) => apt.patient_name
          )
        ).size;
        document.getElementById("completedCount").textContent =
          data.today.filter((apt) => apt.status === "completed").length;

        // Display appointments
        displayAppointments(data.today, "todayAppointments", true);
        displayAppointments(data.upcoming.slice(0, 10), "upcomingAppointments"); // Show only next 10
        displayAppointments(data.past.slice(0, 10), "pastAppointments"); // Show only recent 10

        allAppointments = [...data.today, ...data.upcoming, ...data.past];
      }

      function displayAppointments(appointments, containerId, isToday = false) {
        const container = document.getElementById(containerId);

        if (!appointments || appointments.length === 0) {
          container.innerHTML =
            '<div class="no-data">No appointments found</div>';
          return;
        }

        container.innerHTML = appointments
          .map(
            (apt) => `
                <div class="appointment-card ${isToday ? "today" : ""} ${
              apt.status === "completed" ? "completed" : ""
            }">
                    <div class="appointment-header">
                        <span class="patient-name">üë§ ${apt.patient_name}</span>
                        <span class="appointment-time">‚è∞ ${apt.time}</span>
                    </div>
                    <div class="appointment-details">
                        <p><strong>üìÖ Date:</strong> ${formatDate(apt.date)}</p>
                        <p><strong>üìä Status:</strong> <span class="status-badge status-${
                          apt.status
                        }">${apt.status}</span></p>
                        ${
                          apt.prescription
                            ? `<p><strong>üíä Prescription:</strong> ${apt.prescription.substring(
                                0,
                                50
                              )}${
                                apt.prescription.length > 50 ? "..." : ""
                              }</p>`
                            : ""
                        }
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-small" onclick="viewPatientDetails('${
                          apt.patient_name
                        }')">üëÅÔ∏è View Details</button>
                        ${
                          apt.status === "booked"
                            ? `
                            <button class="btn btn-success btn-small" onclick="markCompleted(${apt.id})">‚úÖ Mark Complete</button>
                        `
                            : ""
                        }
                        <button class="btn btn-secondary btn-small" onclick="addPrescription(${
                          apt.id
                        }, '${apt.patient_name}')">üíä Add Prescription</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      async function searchPatient() {
        const username = document.getElementById("patientSearch").value.trim();
        if (!username) {
          showMessage("Please enter a patient username", "error");
          return;
        }

        await viewPatientDetails(username);
      }

      function clearSearch() {
        document.getElementById("patientSearch").value = "";
      }

      async function viewPatientDetails(username) {
        // Open patient detail page in new tab
        window.open(
          `/frontend/patient_detail.html?patient=${username}`,
          "_blank"
        );
      }

      async function markCompleted(appointmentId) {
        if (!confirm("Mark this appointment as completed?")) {
          return;
        }

        try {
          const response = await fetch(`/api/appointments/${appointmentId}/`, {
            method: "PATCH",
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              status: "completed",
            }),
          });

          if (response.ok) {
            showMessage("‚úÖ Appointment marked as completed!", "success");
            await loadDoctorDashboard();
          } else {
            const error = await response.json();
            showMessage(
              "Failed to update appointment: " +
                (error.error || "Unknown error"),
              "error"
            );
          }
        } catch (error) {
          console.error("Error updating appointment:", error);
          showMessage("Error updating appointment: " + error.message, "error");
        }
      }

      async function addPrescription(appointmentId, patientName) {
        // Open patient detail page with specific appointment
        window.open(
          `/frontend/patient_detail.html?patient=${patientName}&appointment=${appointmentId}`,
          "_blank"
        );
      }

      async function viewAllDocuments() {
        // Implement view all documents functionality
        showMessage("Opening documents view...", "success");
      }

      async function refreshDashboard() {
        showMessage("üîÑ Refreshing dashboard...", "success");
        await loadDoctorDashboard();
        showMessage("‚úÖ Dashboard refreshed!", "success");
      }

      // Chatbot functions
      function toggleChatbot() {
        if (chatbotOpen) {
          closeChatbot();
        } else {
          openChatbot();
        }
      }

      function openChatbot() {
        chatbotOpen = true;
        document.getElementById("chatbotModal").style.display = "block";
        document.getElementById("chatbotToggle").classList.add("active");
        document.getElementById("chatbotToggle").innerHTML = "‚ùå";

        // Focus on input
        setTimeout(() => {
          document.getElementById("chatbotInput").focus();
        }, 100);
      }

      function closeChatbot() {
        chatbotOpen = false;
        document.getElementById("chatbotModal").style.display = "none";
        document.getElementById("chatbotToggle").classList.remove("active");
        document.getElementById("chatbotToggle").innerHTML = "üí¨";
      }

      async function handleChatbotMessage(e) {
        e.preventDefault();

        const messageInput = document.getElementById("chatbotInput");
        const sendBtn = document.getElementById("chatbotSendBtn");
        const message = messageInput.value.trim();

        if (!message) return;

        // Add user message to chat
        addChatMessage(message, "user");

        // Clear input and disable send button
        messageInput.value = "";
        messageInput.style.height = "auto";
        sendBtn.disabled = true;

        // Show typing indicator
        showChatbotTyping();

        try {
          const response = await fetch("/api/chat/", {
            method: "POST",
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
            }),
          });

          hideChatbotTyping();

          if (response.ok) {
            const data = await response.json();
            addChatMessage(data.response, "bot");
          } else {
            const errorData = await response.json();
            addChatMessage(
              "Sorry, I encountered an error. Please try again.",
              "bot",
              true
            );
          }
        } catch (error) {
          hideChatbotTyping();
          console.error("Chat error:", error);
          addChatMessage(
            "Sorry, I'm having trouble connecting. Please try again.",
            "bot",
            true
          );
        } finally {
          sendBtn.disabled = false;
          messageInput.focus();
        }
      }

      function addChatMessage(content, sender, isError = false) {
        const messagesContainer = document.getElementById("chatbotMessages");

        // Remove welcome message if it exists
        const welcomeMsg = messagesContainer.querySelector(".chatbot-welcome");
        if (welcomeMsg) {
          welcomeMsg.remove();
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${sender}`;

        const avatar = document.createElement("div");
        avatar.className = "chat-avatar";
        avatar.textContent = sender === "user" ? "üë§" : "ü§ñ";

        const messageContent = document.createElement("div");
        messageContent.className = "chat-message-content";

        if (isError) {
          messageContent.style.background = "#ffebee";
          messageContent.style.color = "#c62828";
          messageContent.style.borderColor = "#f44336";
        }

        // Format message content (preserve line breaks)
        messageContent.innerHTML = content.replace(/\n/g, "<br>");

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        messagesContainer.appendChild(messageDiv);

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function showChatbotTyping() {
        const typingIndicator = document.getElementById("chatbotTyping");
        const messagesContainer = document.getElementById("chatbotMessages");

        typingIndicator.style.display = "block";
        messagesContainer.appendChild(typingIndicator);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function hideChatbotTyping() {
        const typingIndicator = document.getElementById("chatbotTyping");
        typingIndicator.style.display = "none";

        // Remove from messages container if it's there
        const messagesContainer = document.getElementById("chatbotMessages");
        if (messagesContainer.contains(typingIndicator)) {
          messagesContainer.removeChild(typingIndicator);
        }
      }

      function showMessage(message, type) {
        // Remove existing message
        const existingMessage = document.querySelector(".global-message");
        if (existingMessage) {
          existingMessage.remove();
        }

        const className =
          type === "error" ? "error-message" : "success-message";
        const messageDiv = document.createElement("div");
        messageDiv.className = `global-message ${className}`;
        messageDiv.innerHTML = message;
        messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                padding: 15px;
                border-radius: 5px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;

        document.body.appendChild(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          localStorage.removeItem("token");
          localStorage.removeItem("role");
          window.location.href = "/frontend/login.html";
        }
      }

      // Close chatbot with Escape key
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && chatbotOpen) {
          closeChatbot();
        }
      });

      const chatBtn = document.getElementById("chatbotBtn");
      const chatWin = document.getElementById("chatWindow");
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatText");
      const chatSend = document.getElementById("chatSend");
      let history = [];

      chatBtn.addEventListener("click", () => {
        chatWin.style.display =
          chatWin.style.display === "none" ? "flex" : "none";
        
        // Clear empty state when opening
        if (chatWin.style.display === "flex") {
          const emptyState = chatMessages.querySelector(".empty-chat-state");
          if (emptyState && chatMessages.children.length === 1) {
            // Keep empty state if no messages yet
          }
        }
      });

      function addMsg(text, sender) {
        // Remove empty state when first message is added
        const emptyState = chatMessages.querySelector(".empty-chat-state");
        if (emptyState) {
          emptyState.remove();
        }

        const div = document.createElement("div");
        div.className = sender === "user" ? "msg-user" : "msg-bot";
        div.textContent = text;
        div.style.position = "relative";
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendChat() {
        const text = chatInput.value.trim();
        if (!text) return;

        addMsg(text, "user");
        history.push({ role: "user", content: text });
        chatInput.value = "";

        // Show typing indicator
        const typingDiv = document.createElement("div");
        typingDiv.className = "typing-indicator";
        typingDiv.innerHTML = 'AI is typing<span class="typing-dots">...</span>';
        typingDiv.style.display = "block";
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const res = await fetch("http://127.0.0.1:8000/api/chat/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Token ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ messages: history }),
          });

          // Remove typing indicator
          typingDiv.remove();

          const data = await res.json();
          if (res.ok && data.reply) {
            addMsg(data.reply, "bot");
            history.push({ role: "assistant", content: data.reply });
          } else {
            addMsg(data.detail || "Error: Unable to get response.", "bot");
          }
        } catch (error) {
          // Remove typing indicator
          typingDiv.remove();
          console.error("Chat error:", error);
          addMsg("Error: Could not connect to chatbot.", "bot");
        }
      }

      chatSend.addEventListener("click", sendChat);
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendChat();
      });

      // ‚úÖ Modal close button event listener
      document
        .querySelector(".close")
        .addEventListener("click", closeUpdateModal);

      // ‚úÖ Close modal when clicking outside
      window.addEventListener("click", (event) => {
        const modal = document.getElementById("updateModal");
        if (event.target === modal) {
          closeUpdateModal();
        }
      });

    </script>
  </body>
</html>
