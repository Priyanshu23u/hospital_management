<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Details - Hospital Management</title>
    <style>
      /* Markdown content styling */
      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3,
      .markdown-content h4,
      .markdown-content h5 {
        margin: 0.6em 0 0.3em;
      }
      .markdown-content ul,
      .markdown-content ol {
        margin-left: 1.25em;
      }
      .markdown-content code {
        background: #f0f0f0;
        padding: 2px 4px;
        border-radius: 3px;
      }
      .markdown-content blockquote {
        border-left: 4px solid #ddd;
        padding-left: 1em;
        margin: 1em 0;
        font-style: italic;
      }
      .markdown-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 1em 0;
      }
      .markdown-content th,
      .markdown-content td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      .markdown-content th {
        background-color: #f2f2f2;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50, #3498db);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .back-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        transition: background 0.3s;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .main-content {
        padding: 30px;
      }

      .patient-header {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        border-left: 4px solid #3498db;
      }

      .patient-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .info-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .info-card h4 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 1em;
      }

      .info-card p {
        color: #666;
        margin: 5px 0;
        font-size: 0.9em;
      }

      .sections-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .section h3 {
        color: #2c3e50;
        font-size: 1.3em;
        margin: 0;
      }

      .appointment-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #3498db;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .appointment-card.completed {
        border-left-color: #27ae60;
        background: #f0fff4;
      }

      .appointment-card.booked {
        border-left-color: #f39c12;
        background: #fffbf0;
      }

      .appointment-card.cancelled {
        border-left-color: #e74c3c;
        background: #fff5f5;
      }

      .appointment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .appointment-date {
        font-weight: bold;
        color: #2c3e50;
      }

      .appointment-time {
        background: #3498db;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
      }

      .appointment-details p {
        margin: 5px 0;
        color: #666;
        font-size: 0.9em;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }

      .status-booked {
        background: #fff3cd;
        color: #856404;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
      }

      .prescription-text {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-style: italic;
        border-left: 3px solid #2196f3;
      }

      .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
      }

      .document-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .document-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .doc-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .doc-header h4 {
        margin: 0;
        color: #2c3e50;
        font-size: 1em;
      }

      .doc-date {
        font-size: 0.8em;
        color: #666;
      }

      .doc-content p {
        margin: 8px 0;
        font-size: 0.9em;
        color: #555;
      }

      .doc-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: all 0.3s;
        font-size: 0.9em;
        margin: 3px;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background: #2980b9;
      }

      .btn-secondary {
        background: #95a5a6;
        color: white;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }

      .btn-success {
        background: #27ae60;
        color: white;
      }

      .btn-success:hover {
        background: #229954;
      }

      .btn-small {
        padding: 5px 10px;
        font-size: 0.8em;
      }

      .prescription-form {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #2c3e50;
      }

      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1em;
      }

      .form-group textarea {
        min-height: 120px;
        resize: vertical;
        font-family: inherit;
      }

      .ai-summary {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #9c27b0;
      }

      .ai-summary-content {
        background: #f3e5f5;
        padding: 15px;
        border-radius: 5px;
        white-space: pre-wrap;
        line-height: 1.6;
        margin-top: 10px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .no-data {
        text-align: center;
        padding: 30px;
        color: #999;
        font-style: italic;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #f44336;
      }

      .success-message {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #4caf50;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      .debug-info {
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        font-family: monospace;
        font-size: 0.9em;
      }

      .doc-type-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.7em;
        font-weight: bold;
        text-transform: uppercase;
        margin-left: 10px;
      }

      .doc-type-lab {
        background: #e3f2fd;
        color: #1976d2;
      }

      .doc-type-scan {
        background: #fff3e0;
        color: #f57c00;
      }

      .doc-type-prescription {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .doc-type-other {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      @media (max-width: 1024px) {
        .sections-grid {
          grid-template-columns: 1fr;
        }

        .patient-info {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 20px;
        }

        .documents-grid {
          grid-template-columns: 1fr;
        }

        .appointment-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üë§ Patient Details</h1>
        <a href="/frontend/doctor_dashboard.html" class="back-btn"
          >‚Üê Back to Dashboard</a
        >
      </div>

      <div class="main-content">
        <!-- Debug Information -->
        <div class="debug-info" id="debugInfo">
          <strong>Debug Information:</strong><br />
          URL: <span id="currentURL"></span><br />
          Patient Username: <span id="debugUsername"></span><br />
          Auth Token: <span id="debugToken"></span>
        </div>

        <!-- Patient Information -->
        <div class="patient-header">
          <h2>üîç Patient Information</h2>
          <div class="patient-info" id="patientInfo">
            <div class="loading">Loading patient information...</div>
          </div>
          <button class="btn btn-secondary" onclick="refreshPatientInfo()">
            üîÑ Refresh
          </button>
        </div>

        <div class="sections-grid">
          <!-- Appointment History -->
          <div class="section">
            <div class="section-header">
              <h3>üìÖ Appointment History</h3>
              <button
                class="btn btn-primary btn-small"
                onclick="generateMedicalSummary()"
              >
                ü§ñ Generate AI Summary
              </button>
            </div>
            <div id="appointmentHistory">
              <div class="loading">Loading appointment history...</div>
            </div>
          </div>

          <!-- Medical Documents -->
          <div class="section">
            <div class="section-header">
              <h3>üìã Medical Documents</h3>
              <button
                class="btn btn-secondary btn-small"
                onclick="refreshDocuments()"
              >
                üîÑ Refresh Documents
              </button>
            </div>
            <div id="documentsContainer">
              <div class="loading">Loading documents...</div>
            </div>
          </div>
        </div>

        <!-- AI Medical Summary -->
        <div
          class="section full-width"
          id="aiSummarySection"
          style="display: none"
        >
          <div class="section-header">
            <h3>ü§ñ AI Medical Summary</h3>
            <button
              class="btn btn-secondary btn-small"
              onclick="hideAISummary()"
            >
              ‚ùå Hide Summary
            </button>
          </div>
          <div id="aiSummaryContent" class="markdown-content">
            <!-- AI summary will be loaded here -->
          </div>
        </div>

        <!-- Prescription Management -->
        <div class="section full-width">
          <h3>üíä Add/Update Prescription</h3>
          <div class="prescription-form">
            <form id="prescriptionForm">
              <div class="form-group">
                <label>Select Appointment:</label>
                <select id="appointmentSelect" required>
                  <option value="">Select an appointment</option>
                  <!-- Will be populated dynamically -->
                </select>
              </div>
              <div class="form-group">
                <label>Prescription/Notes:</label>
                <textarea
                  id="prescriptionText"
                  placeholder="Enter prescription details, medical notes, or treatment recommendations..."
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn btn-success">
                üíæ Save Prescription
              </button>
            </form>
            <div id="prescriptionMessages"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentPatientUsername = null;
      let patientAppointments = [];

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        extractPatientUsername();
        updateDebugInfo();
        loadPatientDetails();
        setupEventListeners();
      });

      function checkAuth() {
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");

        if (!token || role !== "doctor") {
          window.location.href = "/frontend/login.html";
          return;
        }
      }

      function extractPatientUsername() {
        // Get patient username from URL hash or query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(
          window.location.hash.substring(1)
        );

        currentPatientUsername =
          urlParams.get("patient") ||
          hashParams.get("patient") ||
          getPatientFromPath();

        if (!currentPatientUsername) {
          showMessage(
            "No patient specified. Please select a patient from the dashboard.",
            "error"
          );
          setTimeout(() => {
            window.location.href = "/frontend/doctor_dashboard.html";
          }, 3000);
        }
      }

      function getPatientFromPath() {
        // Try to extract from URL path like /patient-detail/username
        const path = window.location.pathname;
        const segments = path.split("/");
        return segments[segments.length - 1] || null;
      }

      function updateDebugInfo() {
        document.getElementById("currentURL").textContent =
          window.location.href;
        document.getElementById("debugUsername").textContent =
          currentPatientUsername || "Not found";
        document.getElementById("debugToken").textContent =
          localStorage.getItem("token") ? "Present" : "Missing";
      }

      function setupEventListeners() {
        // Prescription form
        document
          .getElementById("prescriptionForm")
          .addEventListener("submit", handlePrescriptionSave);
      }

      async function loadPatientDetails() {
        if (!currentPatientUsername) return;

        await Promise.all([
          loadPatientInfo(),
          loadAppointmentHistory(),
          refreshDocuments(),
        ]);
      }

      async function loadPatientInfo() {
        try {
          // For now, we'll show basic info from the username
          // In a full implementation, you might have a separate patient info endpoint
          const patientInfoHtml = `
                    <div class="info-card">
                        <h4>üë§ Basic Information</h4>
                        <p><strong>Username:</strong> ${currentPatientUsername}</p>
                        <p><strong>Role:</strong> Patient</p>
                    </div>
                    <div class="info-card">
                        <h4>üìä Status</h4>
                        <p><strong>Profile:</strong> Active</p>
                        <p><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                `;
          document.getElementById("patientInfo").innerHTML = patientInfoHtml;
        } catch (error) {
          console.error("Error loading patient info:", error);
          document.getElementById("patientInfo").innerHTML =
            '<div class="error-message">Error loading patient information</div>';
        }
      }

      async function loadAppointmentHistory() {
        try {
          const response = await fetch(
            `/api/doctor/patient/${currentPatientUsername}/`,
            {
              headers: {
                Authorization: `Token ${localStorage.getItem("token")}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            patientAppointments = data.appointments || [];
            displayAppointmentHistory(patientAppointments);
            populateAppointmentDropdown(patientAppointments);
          } else {
            const error = await response.json();
            document.getElementById(
              "appointmentHistory"
            ).innerHTML = `<div class="error-message">Error: ${
              error.error || "Failed to load appointments"
            }</div>`;
          }
        } catch (error) {
          console.error("Error loading appointment history:", error);
          document.getElementById("appointmentHistory").innerHTML =
            '<div class="error-message">Error loading appointment history</div>';
        }
      }

      function displayAppointmentHistory(appointments) {
        const container = document.getElementById("appointmentHistory");

        if (!appointments || appointments.length === 0) {
          container.innerHTML =
            '<div class="no-data">No appointments found for this patient</div>';
          return;
        }

        container.innerHTML = appointments
          .map(
            (apt) => `
                <div class="appointment-card ${apt.status}">
                    <div class="appointment-header">
                        <span class="appointment-date">üìÖ ${formatDate(
                          apt.date
                        )}</span>
                        <span class="appointment-time">‚è∞ ${formatTime(
                          apt.time
                        )}</span>
                    </div>
                    <div class="appointment-details">
                        <p><strong>üìä Status:</strong> <span class="status-badge status-${
                          apt.status
                        }">${apt.status}</span></p>
                        <p><strong>üÜî ID:</strong> ${apt.id}</p>
                        ${
                          apt.prescription
                            ? `
                            <div class="prescription-text">
                                <strong>üíä Prescription/Notes:</strong><br>
                                ${apt.prescription}
                            </div>
                        `
                            : "<p><em>No prescription recorded</em></p>"
                        }
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary btn-small" onclick="editPrescription(${
                          apt.id
                        }, '${apt.prescription || ""}')">
                            ‚úèÔ∏è ${apt.prescription ? "Edit" : "Add"} Prescription
                        </button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function populateAppointmentDropdown(appointments) {
        const select = document.getElementById("appointmentSelect");
        select.innerHTML =
          '<option value="">Select an appointment</option>' +
          appointments
            .map(
              (apt) => `
                    <option value="${apt.id}">
                        ${formatDate(apt.date)} ${formatTime(apt.time)} - ${
                apt.status
              }
                    </option>
                `
            )
            .join("");
      }

      async function refreshDocuments() {
        if (!currentPatientUsername) return;

        try {
          const response = await fetch(
            `/api/patients/${currentPatientUsername}/documents/`,
            {
              headers: {
                Authorization: `Token ${localStorage.getItem("token")}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            displayPatientDocuments(data.documents || []);
          } else {
            document.getElementById("documentsContainer").innerHTML =
              '<div class="no-data">No documents found or error loading documents</div>';
          }
        } catch (error) {
          console.error("Error loading documents:", error);
          document.getElementById("documentsContainer").innerHTML =
            '<div class="error-message">Error loading documents</div>';
        }
      }

      function displayPatientDocuments(documents) {
        const container = document.getElementById("documentsContainer");

        if (!documents || documents.length === 0) {
          container.innerHTML =
            '<div class="no-data">üìÑ No medical documents found for this patient</div>';
          return;
        }

        container.innerHTML = `
                <div class="documents-grid">
                    ${documents
                      .map(
                        (doc) => `
                        <div class="document-card">
                            <div class="doc-header">
                                <h4>
                                    ${getDocumentIcon(doc.doc_type)} ${
                          doc.doc_type
                        }
                                    <span class="doc-type-badge doc-type-${doc.doc_type
                                      .toLowerCase()
                                      .replace(/[^a-z]/g, "")}">${
                          doc.doc_type
                        }</span>
                                </h4>
                                <span class="doc-date">${formatDateTime(
                                  doc.uploaded_at
                                )}</span>
                            </div>
                            <div class="doc-content">
                                ${
                                  doc.description
                                    ? `<p><strong>üìù Description:</strong> ${doc.description}</p>`
                                    : ""
                                }
                                ${
                                  doc.doctor_name
                                    ? `<p><strong>üë®‚Äç‚öïÔ∏è Associated Doctor:</strong> ${doc.doctor_name}</p>`
                                    : ""
                                }
                                ${
                                  doc.file_name
                                    ? `<p><strong>üìé File:</strong> ${doc.file_name}</p>`
                                    : ""
                                }
                                <p><strong>üìÖ Uploaded:</strong> ${formatDateTime(
                                  doc.uploaded_at
                                )}</p>
                            </div>
                            <div class="doc-actions">
                                <a href="${
                                  doc.file_url
                                }" target="_blank" class="btn btn-primary btn-small">
                                    üëÅÔ∏è View
                                </a>
                                <a href="${doc.file_url}" download="${
                          doc.file_name || "document"
                        }" class="btn btn-secondary btn-small">
                                    üì• Download
                                </a>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
      }

      function getDocumentIcon(type) {
        const icons = {
          "Lab Report": "üß™",
          "Scan/X-ray": "üì±",
          Prescription: "üíä",
          Other: "üìÑ",
        };
        return icons[type] || "üìÑ";
      }

      function editPrescription(appointmentId, currentPrescription) {
        document.getElementById("appointmentSelect").value = appointmentId;
        document.getElementById("prescriptionText").value =
          currentPrescription || "";

        // Scroll to prescription form
        document
          .getElementById("prescriptionForm")
          .scrollIntoView({ behavior: "smooth" });
      }

      async function handlePrescriptionSave(e) {
        e.preventDefault();

        const appointmentId =
          document.getElementById("appointmentSelect").value;
        const prescriptionText = document
          .getElementById("prescriptionText")
          .value.trim();

        if (!appointmentId || !prescriptionText) {
          showMessage(
            "Please select an appointment and enter prescription details",
            "error",
            "prescriptionMessages"
          );
          return;
        }

        try {
          const response = await fetch("/api/save-prescription/", {
            method: "POST",
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              appointment_id: appointmentId,
              prescription: prescriptionText,
              notes: prescriptionText,
            }),
          });

          if (response.ok) {
            showMessage(
              "‚úÖ Prescription saved successfully!",
              "success",
              "prescriptionMessages"
            );
            document.getElementById("prescriptionForm").reset();

            // Refresh appointment history to show updated prescription
            await loadAppointmentHistory();
          } else {
            const error = await response.json();
            showMessage(
              "Failed to save prescription: " +
                (error.error || "Unknown error"),
              "error",
              "prescriptionMessages"
            );
          }
        } catch (error) {
          console.error("Error saving prescription:", error);
          showMessage(
            "Error saving prescription: " + error.message,
            "error",
            "prescriptionMessages"
          );
        }
      }

      async function generateMedicalSummary() {
        if (!currentPatientUsername) {
          showMessage("No patient selected", "error");
          return;
        }

        const aiSection = document.getElementById("aiSummarySection");
        const summaryContent = document.getElementById("aiSummaryContent");

        aiSection.style.display = "block";
        summaryContent.innerHTML =
          '<div class="loading">ü§ñ Generating AI medical summary...</div>';

        try {
          const response = await fetch("/api/patient-history-summary/", {
            method: "POST",
            headers: {
              Authorization: `Token ${localStorage.getItem("token")}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              patient_username: currentPatientUsername,
            }),
          });

          if (response.ok) {
            const data = await response.json();
            // Render AI summary as markdown
            summaryContent.innerHTML = `
                <div class="ai-summary">
                    <h4>ü§ñ AI-Generated Medical History Summary</h4>
                    <p><strong>Patient:</strong> ${data.patient_username}</p>
                    <div class="markdown-content">
                        ${marked.parse(data.summary)}
                    </div>
                </div>
            `;
          } else {
            const error = await response.json();
            summaryContent.innerHTML = `
                <div class="error-message">
                    Failed to generate summary: ${
                      error.error || "Unknown error"
                    }
                </div>
            `;
          }
        } catch (error) {
          console.error("Error generating summary:", error);
          summaryContent.innerHTML = `
            <div class="error-message">
                Error generating summary: ${error.message}
            </div>
        `;
        }
      }

      function hideAISummary() {
        document.getElementById("aiSummarySection").style.display = "none";
      }

      async function refreshPatientInfo() {
        await loadPatientInfo();
        showMessage("Patient information refreshed", "success");
      }

      function showMessage(message, type, containerId = null) {
        const className =
          type === "error" ? "error-message" : "success-message";
        const messageHtml = `<div class="${className}">${message}</div>`;

        if (containerId) {
          document.getElementById(containerId).innerHTML = messageHtml;
        } else {
          // Show global message
          const existingMessage = document.querySelector(".global-message");
          if (existingMessage) {
            existingMessage.remove();
          }

          const messageDiv = document.createElement("div");
          messageDiv.className = `global-message ${className}`;
          messageDiv.innerHTML = message;
          messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    max-width: 400px;
                    padding: 15px;
                    border-radius: 5px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                `;

          document.body.appendChild(messageDiv);

          setTimeout(() => {
            messageDiv.remove();
          }, 5000);
        }
      }

      function formatDate(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function formatTime(timeString) {
        if (!timeString) return "N/A";
        // Handle both time objects and string formats
        if (typeof timeString === "string") {
          return timeString;
        }
        return timeString.toString();
      }

      function formatDateTime(dateTimeString) {
        if (!dateTimeString) return "N/A";
        const date = new Date(dateTimeString);
        return date.toLocaleString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Function to navigate to patient detail (for use from dashboard)
      function getPatientUsername() {
        return currentPatientUsername;
      }
    </script>
  </body>
</html>
