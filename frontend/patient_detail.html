<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Details - Hospital Management</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            background: #f4f6fb; 
            line-height: 1.6; 
        }
        
        header { 
            background: linear-gradient(135deg, #2f80ed 0%, #1e40af 100%);
            color: #fff;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header-title p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .card-header {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            margin: 0;
            color: #1e293b;
            font-size: 18px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .info-item {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #2f80ed;
        }
        
        .info-item label {
            font-weight: 600;
            color: #374151;
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .info-item span {
            color: #6b7280;
            font-size: 15px;
        }
        
        /* Table styles */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f1f5f9;
            font-weight: 600;
            color: #374151;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        /* Button styles */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin: 2px;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #2f80ed;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1e40af;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2f80ed;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Document styles */
        .document-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .document-info {
            flex: 1;
        }
        
        .document-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .document-meta {
            font-size: 12px;
            color: #6b7280;
        }
        
        /* AI Summary styles */
        .ai-summary {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 16px;
        }
        
        .ai-summary h4 {
            margin: 0 0 12px 0;
            color: #0369a1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-summary-text {
            white-space: pre-wrap;
            line-height: 1.6;
            color: #1e293b;
        }
        
        /* Status badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-booked {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-confirmed {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-completed {
            background: #f3f4f6;
            color: #374151;
        }
        
        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Alert styles */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            border: 1px solid;
        }
        
        .alert-success {
            background: #dcfce7;
            border-color: #bbf7d0;
            color: #166534;
        }
        
        .alert-error {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b;
        }
        
        .alert-info {
            background: #dbeafe;
            border-color: #bfdbfe;
            color: #1e40af;
        }
        
        /* Loading state */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2f80ed;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-style: italic;
        }
        
        /* Debug info styles */
        .debug-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .document-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .container {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-title">
                <h1 id="patientTitle">Patient Details</h1>
                <p id="doctorInfo">Loading patient information...</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="goBackToDashboard()">‚Üê Back to Dashboard</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Alert container -->
        <div id="alertContainer"></div>
        
        <!-- Debug Info (remove in production) -->
        <div id="debugInfo" class="debug-info" style="display: none;">
            <strong>Debug Information:</strong><br>
            <span id="debugContent"></span>
        </div>

        <!-- Patient Information Card -->
        <div class="card">
            <div class="card-header">
                <h3>üîç Patient Information</h3>
                <button class="btn btn-secondary" onclick="refreshPatientData()">Refresh</button>
            </div>
            <div class="card-body">
                <div class="info-grid" id="patientInfo">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Appointment History Card -->
        <div class="card">
            <div class="card-header">
                <h3>üìÖ Appointment History</h3>
                <button class="btn btn-success" onclick="generateAISummary()">ü§ñ Generate AI Summary</button>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Prescription/Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentHistoryTable">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Medical Documents Card -->
        <div class="card">
            <div class="card-header">
                <h3>üìã Medical Documents</h3>
                <button class="btn btn-secondary" onclick="refreshDocuments()">Refresh Documents</button>
            </div>
            <div class="card-body">
                <div id="documentsContainer">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- AI Medical Summary Card -->
        <div class="card" id="aiSummaryCard" style="display: none;">
            <div class="card-header">
                <h3>ü§ñ AI Medical Summary</h3>
                <button class="btn btn-secondary" onclick="hideAISummary()">Hide Summary</button>
            </div>
            <div class="card-body">
                <div class="ai-summary">
                    <h4>
                        <span>üß†</span>
                        AI-Generated Medical History Summary
                    </h4>
                    <div id="aiSummaryContent" class="ai-summary-text">
                        <!-- AI summary will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Prescription Management Card -->
        <div class="card">
            <div class="card-header">
                <h3>üíä Add/Update Prescription</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="appointmentSelect">Select Appointment</label>
                    <select id="appointmentSelect" class="form-control">
                        <option value="">Select an appointment</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prescriptionText">Prescription/Notes</label>
                    <textarea id="prescriptionText" class="form-control" rows="6" 
                              placeholder="Enter prescription details, diagnosis, treatment plan, notes..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="savePrescription()" id="saveBtn">
                    üíæ Save Prescription
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== AUTHENTICATION AND INITIALIZATION =====
        const token = localStorage.getItem("authToken"); // Use same token name as dashboard
        
        // Debug function
        function showDebugInfo(info) {
            const debugDiv = document.getElementById("debugInfo");
            const debugContent = document.getElementById("debugContent");
            debugDiv.style.display = 'block';
            debugContent.innerHTML = info;
            console.log("DEBUG:", info);
        }
        
        if (!token) {
            alert("Please login first. No authentication token found.");
            window.location.href = "login.html";
        } else {
            showDebugInfo(`Token found: ${token.substring(0, 10)}...`);
        }

        let currentPatientUsername = null;
        let patientData = null;

        // ===== UTILITY FUNCTIONS =====
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById("alertContainer");
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function showError(message) {
            showAlert("Error: " + message, 'error');
            console.error("Error:", message);
        }

        function showSuccess(message) {
            showAlert(message, 'success');
        }

        function setLoading(elementId, loading) {
            const element = document.getElementById(elementId);
            if (loading) {
                element.classList.add('loading');
            } else {
                element.classList.remove('loading');
            }
        }

        function getStatusBadge(status) {
            return `<span class="status-badge status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
        }

        // ===== PATIENT SELECTION =====
        function getSelectedPatient() {
            const patientName = localStorage.getItem('selectedPatient');
            showDebugInfo(`Selected patient from localStorage: ${patientName}`);
            
            if (!patientName) {
                alert("No patient selected. Redirecting to dashboard...");
                window.location.href = "doctor_dashboard.html";
                return null;
            }
            return patientName;
        }

        // ===== MAIN DATA LOADING FUNCTIONS =====
        async function loadPatientData() {
            currentPatientUsername = getSelectedPatient();
            if (!currentPatientUsername) return;

            document.getElementById("patientTitle").textContent = `Patient Details: ${currentPatientUsername}`;
            showDebugInfo(`Loading data for patient: ${currentPatientUsername}`);
            
            try {
                // Load all patient information
                await loadPatientInfo();
                await loadAppointmentHistory();
                await loadPatientDocuments();
            } catch (error) {
                console.error("Error loading patient data:", error);
                showError("Failed to load patient data: " + error.message);
            }
        }

        // ===== LOAD PATIENT INFORMATION =====
        async function loadPatientInfo() {
            try {
                const patientInfoContainer = document.getElementById("patientInfo");
                patientInfoContainer.innerHTML = '<div class="no-data">Loading patient information...</div>';

                const apiUrl = `http://127.0.0.1:8000/api/doctor/patient/${currentPatientUsername}/`;
                showDebugInfo(`API URL: ${apiUrl}<br>Token: ${token.substring(0, 20)}...`);

                // Try to fetch detailed patient info
                const res = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 
                        "Authorization": `Token ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                showDebugInfo(`API Response Status: ${res.status} ${res.statusText}`);
                console.log("Patient API Response:", res);

                if (res.ok) {
                    const data = await res.json();
                    console.log("Patient API Data:", data);
                    patientData = data;
                    const patient = data.patient_info;
                    
                    document.getElementById("doctorInfo").textContent = `Viewing as Dr. ${data.doctor_name}`;
                    
                    // ‚úÖ REMOVED DOB, PHONE, GENDER - Only showing basic info
                    patientInfoContainer.innerHTML = `
                        <div class="info-item">
                            <label>üë§ Username</label>
                            <span>${patient.username}</span>
                        </div>
                        <div class="info-item">
                            <label>üìù Full Name</label>
                            <span>${patient.full_name || 'Not provided'}</span>
                        </div>
                        <div class="info-item">
                            <label>üìß Email</label>
                            <span>${patient.email || 'Not provided'}</span>
                        </div>
                    `;
                } else {
                    // Get error details
                    const errorText = await res.text();
                    console.error("API Error Response:", errorText);
                    showDebugInfo(`API Error: ${res.status} - ${errorText}`);
                    
                    throw new Error(`Patient detail API returned ${res.status}: ${errorText}`);
                }
            } catch (error) {
                console.error("Error loading patient info:", error);
                showError(`Failed to load patient info: ${error.message}`);
                
                // Show fallback info
                document.getElementById("patientInfo").innerHTML = `
                    <div class="info-item">
                        <label>‚ö†Ô∏è Patient Information</label>
                        <span style="color:#ef4444;">Error loading detailed patient information: ${error.message}</span>
                    </div>
                    <div class="info-item">
                        <label>üîß Possible Solutions</label>
                        <span>
                            1. Check if backend server is running<br>
                            2. Verify API endpoint exists: /api/doctor/patient/{username}/<br>
                            3. Check browser console for detailed errors
                        </span>
                    </div>
                `;
            }
        }

        // ===== LOAD APPOINTMENT HISTORY =====
        async function loadAppointmentHistory() {
            try {
                const tableBody = document.getElementById("appointmentHistoryTable");
                const appointmentSelect = document.getElementById("appointmentSelect");
                
                tableBody.innerHTML = '<tr><td colspan="5" class="no-data">Loading appointment history...</td></tr>';
                appointmentSelect.innerHTML = '<option value="">Select an appointment</option>';

                if (patientData && patientData.appointment_history) {
                    const appointments = patientData.appointment_history;
                    console.log("Appointment history:", appointments);
                    
                    if (appointments.length > 0) {
                        tableBody.innerHTML = '';
                        
                        appointments.forEach(appointment => {
                            const prescriptionText = appointment.prescription_text || appointment.notes || 'Not added';
                            const truncatedPrescription = prescriptionText.length > 100 
                                ? prescriptionText.substring(0, 100) + '...' 
                                : prescriptionText;

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><strong>${appointment.date}</strong></td>
                                <td>${appointment.time}</td>
                                <td>${getStatusBadge(appointment.status)}</td>
                                <td title="${prescriptionText}">${truncatedPrescription}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="editPrescription(${appointment.id}, '${appointment.date}', '${appointment.time}')">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    ${prescriptionText !== 'Not added' ? 
                                        `<button class="btn btn-secondary" onclick="viewFullPrescription('${prescriptionText.replace(/'/g, "\\'")}')">
                                            üëÅÔ∏è View Full
                                        </button>` 
                                        : ''
                                    }
                                </td>
                            `;
                            tableBody.appendChild(row);

                            // Add to appointment select
                            const option = document.createElement('option');
                            option.value = appointment.id;
                            option.textContent = `${appointment.date} - ${appointment.time} (${appointment.status})`;
                            appointmentSelect.appendChild(option);
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="5" class="no-data">No appointments found with this doctor</td></tr>';
                    }
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" class="no-data">Unable to load appointment history - API response missing</td></tr>';
                    console.error("No patientData or appointment_history in response");
                }
            } catch (error) {
                console.error("Error loading appointment history:", error);
                document.getElementById("appointmentHistoryTable").innerHTML = 
                    `<tr><td colspan="5" class="no-data">Error loading appointment history: ${error.message}</td></tr>`;
            }
        }

        // ===== LOAD PATIENT DOCUMENTS =====
        async function loadPatientDocuments() {
            try {
                const documentsContainer = document.getElementById("documentsContainer");
                documentsContainer.innerHTML = '<div class="no-data">Loading documents...</div>';

                // ‚úÖ FIXED: Try to fetch documents directly from dedicated API first
                try {
                    // Get patient by username and fetch their documents
                    const documentsRes = await fetch(`http://127.0.0.1:8000/api/patients/${currentPatientUsername}/documents/`, {
                        headers: { 
                            "Authorization": `Token ${token}`,
                            "Content-Type": "application/json"
                        }
                    });

                    console.log("Documents API Response:", documentsRes);

                    if (documentsRes.ok) {
                        const documents = await documentsRes.json();
                        console.log("Documents data:", documents);
                        
                        if (documents && documents.length > 0) {
                            documentsContainer.innerHTML = documents.map(doc => `
                                <div class="document-item">
                                    <div class="document-info">
                                        <div class="document-name">üìÑ ${doc.doc_type || doc.name || 'Medical Document'}</div>
                                        <div class="document-meta">
                                            Uploaded: ${doc.uploaded_at || 'Date not available'}
                                            ${doc.appointment_id ? ` | Related to Appointment #${doc.appointment_id}` : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-primary" onclick="viewDocument('${doc.file_url || doc.file}')">
                                            üëÅÔ∏è View
                                        </button>
                                        <button class="btn btn-secondary" onclick="downloadDocument('${doc.file_url || doc.file}')">
                                            üíæ Download
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            return; // Exit successfully
                        }
                    }
                } catch (docApiError) {
                    console.log("Direct documents API failed, trying patient detail API...", docApiError);
                }

                // ‚úÖ FALLBACK: Try from patient detail API response
                if (patientData && patientData.documents) {
                    const documents = patientData.documents;
                    console.log("Documents from patient API:", documents);
                    
                    if (documents.length > 0) {
                        documentsContainer.innerHTML = documents.map(doc => `
                            <div class="document-item">
                                <div class="document-info">
                                    <div class="document-name">üìÑ ${doc.doc_type}</div>
                                    <div class="document-meta">
                                        Uploaded: ${doc.uploaded_at}
                                        ${doc.appointment_id ? ` | Related to Appointment #${doc.appointment_id}` : ''}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="viewDocument('${doc.file_url}')">
                                        üëÅÔ∏è View
                                    </button>
                                    <button class="btn btn-secondary" onclick="downloadDocument('${doc.file_url}')">
                                        üíæ Download
                                    </button>
                                </div>
                            </div>
                        `).join('');
                        return; // Exit successfully
                    }
                }

                // ‚úÖ FINAL FALLBACK: Try to fetch all documents and filter by patient
                try {
                    const allDocsRes = await fetch(`http://127.0.0.1:8000/api/documents/`, {
                        headers: { 
                            "Authorization": `Token ${token}`,
                            "Content-Type": "application/json"
                        }
                    });

                    if (allDocsRes.ok) {
                        const allDocs = await allDocsRes.json();
                        console.log("All documents:", allDocs);
                        
                        // Filter documents for current patient (by username)
                        const patientDocs = allDocs.filter(doc => 
                            doc.patient_username === currentPatientUsername || 
                            doc.patient === currentPatientUsername ||
                            (doc.patient_info && doc.patient_info.username === currentPatientUsername)
                        );
                        
                        if (patientDocs.length > 0) {
                            documentsContainer.innerHTML = patientDocs.map(doc => `
                                <div class="document-item">
                                    <div class="document-info">
                                        <div class="document-name">üìÑ ${doc.doc_type || doc.name || 'Medical Document'}</div>
                                        <div class="document-meta">
                                            Uploaded: ${doc.uploaded_at || 'Date not available'}
                                            ${doc.appointment_id ? ` | Related to Appointment #${doc.appointment_id}` : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-primary" onclick="viewDocument('${doc.file_url || doc.file}')">
                                            üëÅÔ∏è View
                                        </button>
                                        <button class="btn btn-secondary" onclick="downloadDocument('${doc.file_url || doc.file}')">
                                            üíæ Download
                                        </button>
                                    </div>
                                </div>
                            `).join('');
                            return; // Exit successfully
                        }
                    }
                } catch (allDocsError) {
                    console.log("All documents API also failed:", allDocsError);
                }

                // If we reach here, no documents were found
                documentsContainer.innerHTML = '<div class="no-data">üìÑ No documents uploaded by this patient</div>';

            } catch (error) {
                console.error("Error loading patient documents:", error);
                document.getElementById("documentsContainer").innerHTML = 
                    `<div class="no-data">‚ùå Error loading documents: ${error.message}</div>`;
            }
        }

        // ===== PRESCRIPTION MANAGEMENT =====
        function editPrescription(appointmentId, date, time) {
            document.getElementById("appointmentSelect").value = appointmentId;
            
            // Load existing prescription if available
            if (patientData && patientData.appointment_history) {
                const appointment = patientData.appointment_history.find(a => a.id === appointmentId);
                if (appointment && appointment.prescription_text) {
                    document.getElementById("prescriptionText").value = appointment.prescription_text;
                }
            }
            
            // Scroll to prescription section
            document.getElementById("prescriptionText").scrollIntoView({ behavior: 'smooth' });
            showAlert(`Selected appointment: ${date} at ${time}`, 'info');
        }

        async function savePrescription() {
            const appointmentId = document.getElementById("appointmentSelect").value;
            const prescriptionText = document.getElementById("prescriptionText").value.trim();

            if (!appointmentId) {
                showError("Please select an appointment");
                return;
            }

            if (!prescriptionText) {
                showError("Please enter prescription/notes");
                return;
            }

            const saveBtn = document.getElementById("saveBtn");
            setLoading('saveBtn', true);
            saveBtn.innerHTML = '<div class="spinner"></div>Saving Prescription...';

            try {
                // Try new prescription API first
                let res = await fetch("http://127.0.0.1:8000/api/save-prescription/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Token ${token}`
                    },
                    body: JSON.stringify({
                        appointment_id: appointmentId,
                        prescription: prescriptionText,
                        notes: prescriptionText
                    })
                });

                console.log("Save prescription response:", res);

                if (!res.ok) {
                    console.log("Trying fallback appointment API...");
                    // Fallback to appointment update API
                    res = await fetch(`http://127.0.0.1:8000/api/appointments/${appointmentId}/`, {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Token ${token}`
                        },
                        body: JSON.stringify({ prescription: prescriptionText })
                    });
                }

                if (res.ok) {
                    showSuccess("Prescription saved successfully!");
                    document.getElementById("prescriptionText").value = "";
                    document.getElementById("appointmentSelect").value = "";
                    
                    // Reload patient data
                    await loadPatientData();
                } else {
                    const errorData = await res.text();
                    console.error("Save prescription error:", errorData);
                    throw new Error(`Server returned ${res.status}: ${errorData}`);
                }
            } catch (error) {
                console.error("Save prescription error:", error);
                showError("Failed to save prescription: " + error.message);
            } finally {
                setLoading('saveBtn', false);
                saveBtn.innerHTML = 'üíæ Save Prescription';
            }
        }

        // ===== AI SUMMARY =====
        async function generateAISummary() {
            const summaryCard = document.getElementById("aiSummaryCard");
            const summaryContent = document.getElementById("aiSummaryContent");
            
            summaryCard.style.display = 'block';
            summaryContent.innerHTML = 'ü§î Generating AI summary...';
            
            try {
                const res = await fetch("http://127.0.0.1:8000/api/patient-history-summary/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Token ${token}`
                    },
                    body: JSON.stringify({ 
                        patient_username: currentPatientUsername 
                    })
                });

                console.log("AI Summary response:", res);

                if (res.ok) {
                    const data = await res.json();
                    summaryContent.innerHTML = data.summary.replace(/\n/g, '<br>');
                    showSuccess("AI summary generated successfully!");
                } else {
                    const errorData = await res.text();
                    console.error("AI Summary error:", errorData);
                    throw new Error(`Server returned ${res.status}: ${errorData}`);
                }
            } catch (error) {
                console.error("AI summary error:", error);
                summaryContent.innerHTML = `‚ùå Error generating summary: ${error.message}`;
                showError("Failed to generate AI summary");
            }
        }

        // ===== DOCUMENT FUNCTIONS =====
        function viewFullPrescription(prescription) {
            const prescriptionWindow = window.open('', '_blank', 'width=600,height=400,scrollbars=yes,resizable=yes');
            prescriptionWindow.document.write(`
                <html>
                    <head>
                        <title>Prescription Details</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            .header { background: #2f80ed; color: white; padding: 15px; margin: -20px -20px 20px -20px; }
                            .prescription-content { background: #f9f9f9; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
                            .print-btn { background: #2f80ed; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; margin-right: 10px; }
                            .print-btn:hover { background: #1e40af; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h2>üíä Prescription Details</h2>
                            <p>Patient: ${currentPatientUsername}</p>
                        </div>
                        <div class="prescription-content">${prescription}</div>
                        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
                        <button class="print-btn" onclick="window.close()" style="background: #6b7280;">‚ùå Close</button>
                    </body>
                </html>
            `);
        }

        function viewDocument(url) {
            if (url) {
                window.open(url, '_blank');
            } else {
                showError("Document URL not available");
            }
        }

        function downloadDocument(url) {
            if (url) {
                const link = document.createElement('a');
                link.href = url;
                link.download = '';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showError("Document URL not available");
            }
        }

        // ===== REFRESH FUNCTIONS =====
        async function refreshPatientData() {
            showAlert("Refreshing patient data...", 'info');
            await loadPatientData();
            showSuccess("Patient data refreshed!");
        }

        async function refreshDocuments() {
            await loadPatientDocuments();
            showSuccess("Documents refreshed!");
        }

        function hideAISummary() {
            document.getElementById("aiSummaryCard").style.display = 'none';
        }

        // ===== NAVIGATION FUNCTIONS =====
        function goBackToDashboard() {
            localStorage.removeItem('selectedPatient');
            window.location.href = "doctor_dashboard.html";
        }

        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.removeItem("authToken");
                localStorage.removeItem('selectedPatient');
                showSuccess("Logged out successfully");
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 1000);
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener("DOMContentLoaded", () => {
            console.log("Page loaded, initializing...");
            loadPatientData();
            
            // Add keyboard shortcuts
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    goBackToDashboard();
                }
                
                if (e.ctrlKey && e.key === "r") {
                    e.preventDefault();
                    refreshPatientData();
                }
            });
        });
    </script>
</body>
</html>
